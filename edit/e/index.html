<!DOCTYPE HTML>
<!--
    index.html is part of Appudo

    Copyright (C) 2011-2016
        31e58341d31d3a196ed6502a68b4f87115456459d60f5a1d70c00779266aec60 source@appudo.com
        00bd5bdef476a7cd2138cc18cb0274bf9dac8503cf7f406bcdff73381391c976 source@appudo.com
        45228db3f8134a2c8b24246916d30bb3f66409f40611e6027e8e66b80ca59bd0 source@appudo.com

    A small portion of the javascript code is altered code from the Dojo Toolkit.

    Licensed under the Apache License, Version 2.0

    See http://www.apache.org/licenses/LICENSE-2.0 for more information
-->
<html>
<head>
    <meta charset="utf-8">
	<link rel="stylesheet" href="./release/dijit/themes/claro/document.css"/>
	<link rel="stylesheet" href="./release/dijit/themes/claro/claro.css"/>
	<style type="text/css">
		@import "./release/dojox/grid/resources/Grid.css";
  		@import "./release/dojox/grid/resources/claroGrid.css";
  		
		.claro  .dijitTooltipContainer {
			border-radius:0px;
			-moz-border-radius:0px;
		}
		.claro .dijitButtonNode {
 			-webkit-transition-duration:0s !important;
		}
		
		.dBtn .dijitButton .dijitButtonNode, 
		.fBtn .dijitButton .dijitButtonNode,
		.Btn .dijitButton .dijitButtonNode
		 {
			border-radius:0px;
			-moz-border-radius:0px;
			-webkit-box-shadow: transparent 0px 0px 0px;
			background-color: #EAEFFF;
			border: 1px solid #91A4B5;
			background-position: 0px -149px;
		}				
		.claro .dijitTabContainerNested .dijitTabContainerTop-tabs {
			border-bottom:none;
			padding-bottom:7px;
		}
 		.claro .dijitTabContainerTabListNested .dijitTabContent {
 			background-color:#e9f4fe;
			border-radius:0px;
			border-bottom-width:1px;
 			-webkit-transition-property:none;
 			-webkit-transition-duration:0s;
 			-moz-transition-duration:0s;
			-moz-border-radius:0px;
 		}
		.claro .dijitTabContainerTabListNested .dijitTab .dijitTabInnerDiv {
			border:solid 1px #F3F9FE;
 			-webkit-transition-duration:0s;
 			-moz-transition-duration:0s;
 		}
		.claro .dijitTabContainerTabListNested .dijitTabHover .dijitTabContent {
 			-webkit-transition-duration:0s;
 			-moz-transition-duration:0s;
			background-color:#C5E1F8;
		}
		.claro .dijitTabContainerTabListNested .dijitTabContent { 
  			border:1px solid #b5bcc7 !important;
			padding:4px !important;
		}
		
		.claro .dijitTabContainerTabListNested .dijitTabActive .dijitTabContent {
			background-color:#D6E7F5;
			
		}
		.claro .dijitTabContainerTabListNested .dijitTabChecked .dijitTabContent {
			background-color:#C5E1F8;
			border-color:#769dc0 !important;
		}
	
		.claro .dijitTreeNode .dijitTreeRowSelected {
			background-repeat:repeat-x;
			background-color:#cfe5fa;
			padding:3px 0 1px;
			margin:0;
			border:solid 1px #769dc0;
			color:#000000;
		}
		.claro .dijitTreeRowHover {
			background-color:none;
			background-color:transparent;
			background-color:rgba(171, 214, 255, 0);  
			padding:4px 1px 2px 0;
  			margin:0 1px;
			border-width:0;
			color:inherited;
		}
		.nonModal_underlay {
    		display:none
		}
		
		.mRow {
			margin-top:-22px !important;
		}
		
		.claro .dijitDialogTitleBar {
			background:none;
			width:100%;
			padding: 5px 24px 4px 7px;
		}
		
		.claro .dijitDialogTitle { 
			background-position:left;
		}
		
		.claro .dijitDialogPaneContent {
			height:100%;
			background:none;
    		padding: 2px;
		}
		
		.frm textarea {
			float:left;
		}
		
		.frmnb .dijitButtonNode {
			background:none !important;
			border:none !important;
			-webkit-box-shadow:none !important;
			-moz-box-shadow:none !important;
			box-shadow:none !important;
		}
		
		.claro .frm .dijitTitlePaneTitle {
			border: 1px solid #EEE;
			padding: 3px 7px;
		}
		
		.claro .frm .dijitTitlePaneContentOuter {
			border: 1px solid #FFF;
		}
		
		html, body, #container { height:100%; width:100%; padding:0; border:0; overflow:hidden; }
		* { font-size:12px; }
		* {outline: 0;}
		#main { height:100%; width:100%; border:0; padding:4px; }
		#header { margin:0px; }
		#leftAccordion, #rightAccordion { width:15%; }
		.bottomTab { height:20%;overflow:hidden; }

		#loader { 
			padding:0;
			margin:0;
			position:absolute; 
			vertical-align:middle;
			top:0; 
			left:0; 
			width:100%; 
			height:100%;  
			background:#FFF; 
			z-index:500;
		}
		
		#loaderInner {
			padding:5px;
			left:0;
			top:0; 		
			position:relative; 
			font-size:15px;
			width:150px; 	
			background:#E5F1FC; 	
		}
		
		.load {
			z-index:-999;
			position:absolute;
			margin:10px;
			top:0px;
			left:0px;
		}

		hr.spacer { border:0; background-color:#ededed; width:80%; height:1px; } 
  		  		
  		.claro .Selector {
  			background:#EAF0F5;
  		}
  		
  		.claro div.dojoxGrid {
  			border:none;
  		} 
  		
  		.claro .bottomTab div.dojoxGrid {
  			top:23px;
  			margin-bottom:20px;
  		} 
  		
  		.bottomTab .dojoxGridHeader {
  			left:0px !important; 
  		}   		
  		
  		.claro .mPane .dojoxGridMasterHeader {
  			border-top:none;  
  		}  			
  		
  		.claro .mPane .dojoxGridView {
  			top:-1px !important;
  		}
  		
  		.claro .bottomTab .dojoxGridView {
  			top:-2px !important;
  		}
  		
  		.claro .dojoxGridCell {
  			border:1px #FFF solid;
  			border-width: 1px 0 1px 0;  			
  		}
  		
  		.mBtn {
  			float:right;
  			height:0px;
  			padding:0px !important;
  			border:none !important;
  		}
  		  		
		.dijitAccordionText, .dLabel, 
		.dijitDialogTitle, .fInf {
			font-size:1.2em;
		} 
		
		#mainbar {
			padding:1px 3px 1px 3px;
			height:22px;
		}

                .fHeight {
                        height:100% !important;
                }
		
		.cPane > .dijitToolbar {
			text-align:right;
			padding:1px 3px 3px 3px;
			height:20px;
		}
		
		.claro .dijitToolbar > span { 
			margin:0px -2px 0px -2px;
		}
		
		.dijitToolbar .dijitDisabled .dijitIcon {
			alpha(opacity=75);
			-moz-opacity:0.75;
			opacity:0.75;
		}    
		
		.cPane {
			overflow:hidden !important;
			padding:0px !important;
		}  
		
		.cCont .dijitTabPaneWrapper {
			border-top:none;
		}
		
    	.barCont {
    		margin:0px;
    	}			
    	
    	.barCont > .dijitToolbar {
    		padding-bottom:3px;
    	}	
    	
    	.iModIAdd, .iRwnd, .iFwrd,
		.iPAdd, .iGAdd, .iCAdd,
		.iMin, .iTGear, .iInt,
		.iMax, .iRes, .iWhite,
		.iIMG, .iWait, .iOk,
		.iPDF, .iCSS, .iHTML,
		.iSet, .iPackAdd, .iMsAdd,
    	.iIns, .iMeta, .iRole,
    	.iSubAdd, .iTbl, .iRow,
		.iTmpl, .iPack, .iView, 
    	.iBook, .iOut, .iPlainAdd,
    	.iModRoot, .iFileRoot, .iW,
    	.iRoleAdd, .iVarAdd, .iFile,
		.iCode, .iMark, .iSetAdd,
		.iAdd, .iPropAdd, .iMetaAdd,
		.iDel, .iLock, .iMod,
		.iEye, .iModAdd, .iPageAdd,
		.iPage, .iRoot, .iFileAdd,
		.iFolder, .iFolderAdd, .iFs,
		.iGroup, .iGroupAdd, .iHTMLAdd,
		.iPageRef, .iUser, .iUserAdd,
		.iModRun, .iViewAdd, .iSnip, 
        .iSnipAdd, .iSub, .iTblAdd, 
    	.iProp, .iOpen, .iRen, 
    	.iDisk, .iSkinAdd, .iSkin, 
    	.iErr, .iWarn, .iRew,
    	.iPageL, .iRowAdd, .iMarkAdd,
    	.iVar, .iRem, .iModHalt {
			background-position:center center;
			background-repeat:no-repeat;
			width:16px;
			height:16px;
		}
		.appudoIcon {
			background-position:left center;
			padding:2px 0px 2px 20px;
		}
		
		.appudoIconR {
			background-position:right center;
			padding:2px 20px 2px 0px;
		}	
			
		.iRem {
			background-image:url(./img/delete.png);
		}
		
		.iVar {
			background-image:url(./img/cog.png);
		}
		
		.iRwnd {
			background-image:url(./img/rewnd.png);
		}
		
		.iFwrd {
			background-image:url(./img/forwd.png);
		}
		
		.iRew {
			background-image:url(./img/rew.png);
		}
		
		.iPlainAdd {
			background-image:url(./img/plain_add.png);
		}
		
		.iPackAdd {
			background-image:url(./img/pack_add.png);
		}
		
		.iTmpl {
			background-image:url(./img/tmpl.png);
		}
		
		.iView {
			background-image:url(./img/view.png);
		}
		
    	.iOut {
			background-image:url(./img/out.png);
		}
		
		.iAdd {
			background-image:url(./img/add.png);
		}
		
		.iDel {
			background-image:url(./img/bin.png);
		}
		
		.iLock {
			background-image:url(./img/lock_open.png);
		}
		
		.iMod {
			background-image:url(./img/brick.png);
		}
		
		.iMsAdd {
			background-image:url(./img/ms_add.png);
		}
				
		.iSnipAdd {
			background-image:url(./img/snip_add.png);
		}
			
		.iPack {
			background-image:url(./img/pack.png);
		}
		
		.iModIAdd {
			background-image:url(./img/modi_add.png);
		}
		
		.iModRoot {
			background-image:url(./img/mod_root.png);
		}	
			
		.iFileRoot {
			background-image:url(./img/file_root.png);
		}	
			
		.iEye {
			background-image:url(./img/eye.png);
		}		
		
		.iModAdd {
			background-image:url(./img/brick_add.png);
		}	
			
		.iPageAdd {
			background-image:url(./img/page_add.png);
		}
		
		.iPage {
			background-image:url(./img/page_code.png);
		}
		
		.iPageL {
			background-image:url(./img/page_lock.png);
		}
				
		.iRoot {
			background-image:url(./img/page_world.png);
		}
		
		.iFileAdd {
			background-image:url(./img/file_add.png);
		}
		
		.iVarAdd {
			background-image:url(./img/var_add.png);
		}
		
		.iFolder {
			background-image:url(./img/folder.png);
		}
		
		.iFolderAdd {
			background-image:url(./img/folder_add.png);
		}
		
		.iFs {
			background-image:url(./img/fs.png);
		}
		
		.iGroup {
			background-image:url(./img/group.png);
		}
		
		.iW {
			background-image:url(./img/w.png);
		}	
		
		.iBook {
			background-image:url(./img/book.png);
		}
		
		.iGroupAdd {
			background-image:url(./img/group_add.png);
		}
		
		.iHTMLAdd {
			background-image:url(./img/html_add.png);
		}
		
		.iSet {
			background-image:url(./img/set.png);
		}	
		
		.iSetAdd {
			background-image:url(./img/set_add.png);
		}	
		
		.iRole {
			background-image:url(./img/role.png);
		}
		
		.iRoleAdd {
			background-image:url(./img/role_add.png);
		}
		
		.iPageRef {
			background-image:url(./img/page_refresh.png);
		}
		
		.iUser {
			background-image:url(./img/user.png);
		}
		
		.iUserAdd {
			background-image:url(./img/user_add.png);
		}
		
		.iModRun {
			background-image:url(./img/brick_go.png);
		}
		
		.iModHalt {
			background-image:url(./img/brick_halt.png);
		}
		
		.iViewAdd {
			background-image:url(./img/view_add.png);
		}
    	
    	.iFile {
			background-image:url(./img/txt.png);
		}
    	
    	.iSnip {
			background-image:url(./img/snip.png);
		}
    	
    	.iSub {
			background-image:url(./img/sub.png);
		}	
		
    	.iSubAdd {
			background-image:url(./img/sub_add.png);
		}	
		
		.iIns {
			background-image:url(./img/ins.png);
		}	
		
		.iTbl {
			background-image:url(./img/table.png);
		}	
		
    	.iTblAdd {
			background-image:url(./img/table_add.png);
		}	
		
		.iRow {
			background-image:url(./img/row.png);
		}	
		
    	.iRowAdd {
			background-image:url(./img/row_add.png);
		}
		
    	.iDisk {
			background-image:url(./img/disk.png);
		}
		
    	.iProp {
			background-image:url(./img/props.png);
		}
		
    	.iOpen {
			background-image:url(./img/open.png);
		}
		
    	.iRen {
			background-image:url(./img/ren.png);
		}	
		
		.iCode {
			background-image:url(./img/code.png);
		}
			
		.iMark {
			background-image:url(./img/mark.png);
		}
		
		.iMarkAdd {
			background-image:url(./img/mark_add.png);
		}
		
    	.iPropAdd {
			background-image:url(./img/props_add.png);
		}
		
		.iMeta {
			background-image:url(./img/tag.png);
		}
		
		.iMetaAdd {
			background-image:url(./img/tag_add.png);
		}
		
		.iWhite {
			background-image:url(./img/white.png);
		}
		
		.iPDF {
			background-image:url(./img/pdf.png);
		}
		
		.iCSS {
			background-image:url(./img/css.png);
		}
		
		.iHTML {
			background-image:url(./img/html.png);
		}	
						
		.iIMG {
			background-image:url(./img/img.png);
		}
		
		.iWait {
			background-image:url(./img/wait.png);
		}
		
		.iOk {
			background-image:url(./img/ok.png);
		}
		
		.iMin {
			background-image:url(./img/min.png);
		}
		
		.iMax {
			background-image:url(./img/max.png);
		}
		
		.iRes {
			background-image:url(./img/res.png);
		}
		
		.iTGear {
			background-image:url(./img/tgear.png);
		}
		
		.iInt {
			background-image:url(./img/int.png);
		}
		
		.iPAdd {
			background-image:url(./img/p_add.png);
		}
		
		.iGAdd {
			background-image:url(./img/g_add.png);
		}
		
		.iCAdd {
			background-image:url(./img/c_add.png);
		}
		
		.iSkin {
			background-image:url(./img/skin.png);
		}
		
		.iSkinAdd {
			background-image:url(./img/skin_add.png);
		}
		
		.iErr {
			background-image:url(./img/err.png);
		}
		
		.iWarn {
			background-image:url(./img/warn.png);
		}
		
    	#mainTab > .dijitTabPaneWrapper  { 
    		border:none;
    	}   	
    	
    	#mainTab .dijitTabContainerTabListNested, .barCont {
    		border:#B5BCC7 1px solid;
    		border-bottom:none;
    		border-top:none;
    	}    
    	
    	#mainTab .dijitTabContainerTabListNested > div {
    		height:20px;
    		padding-bottom:3px;
    	}
    	    	
    	.dijitTabContainerTabListNested .dijitTabContent:after {
			content:" "; 
			top:0;
			right:-8px;
			border-bottom:13px solid transparent;
			border-top:12px solid transparent;
			border-left:8px solid #B5BCC7;
			position:absolute;
    	}
    	
    	.dijitTabContainerTabListNested .dijitTabInnerDiv:after {
    		content:" "; 
			top:0;
			right:-6px;
    		border-bottom:12px solid transparent;
    		border-top:11px solid transparent;
    		border-left:8px solid #E9F4FE;
    		position:absolute;
    		margin:1px 0px 0px 1px;
    	}  
    	
    	.dijitTabContainerTabListNested .dijitTabHover .dijitTabInnerDiv:after {    	
    		border-left-color:#C5E1F8;
    	}
    	
    	.dijitTabContainerTabListNested .dijitTabHover .dijitTabContent:after { 	
    		border-left-color:#769dc0;
    	}  
    	
    	.dijitTabContainerTabListNested .dijitTabChecked .dijitTabInnerDiv:after {    	
    		border-left-color:#C5E1F8 !important;
    	}
    	
    	.dijitTabContainerTabListNested .dijitTabChecked .dijitTabContent:after { 	
    		border-left-color:#769dc0;
    	}  
    	
    	.dijitTabContainerTabListNested .dijitTabActive .dijitTabInnerDiv:after {  
    		border-left-color:#DAEEFF;
    	}
    	  
    	.dijitTabContainerTabListNested .dijitTab:last-child .dijitTabContent:after,
    	.dijitTabContainerTabListNested .dijitTab:last-child .dijitTabInnerDiv:after {
    		border:0px;
    	} 
    		    	    	
    	.dijitTabContainerTabListNested .dijitTab:nth-child(1) {
    		z-index:8;
    	}   
    	 	
    	.dijitTabContainerTabListNested .dijitTab:nth-child(2) {
    		z-index:7;
    	}   
    	 	
    	.dijitTabContainerTabListNested .dijitTab:nth-child(3) {
    		z-index:6;
    	}    
    	 	
    	.dijitTabContainerTabListNested .dijitTab:nth-child(4) {
    		z-index:5;
    	}  
    	
    	.claro .dijitTabContainerTabListNested .dijitTabContent {
    		padding-left:9px !important;
    	}		
    	
    	.claro .dijitTabContainerBottom-dijitContentPane {
    		padding:0px 0px 5px 0px;
    		overflow:hidden;
    	}
    	
    	.dijitTabContainerBottom-dijitContentPane > .dijitToolbar {
			padding:0px 2px 2px 2px;
			height:22px;
			width:100%;
			position:absolute;
    		z-index:50;
    	}
    	
    	.tabLabel {
    		vertical-align:bottom;
    	}				
    	
    	.dijitTreeLabel {
    		vertical-align:middle;
    	}	
    	
    	.mPane {
    		border:#B5BCC7 1px solid;
    		border-top:none;
    		padding:0px;
    	}
    	
    	.hideExpando .dijitTreeIsRoot > div > img {
    		visibility:hidden;
    		width:0px;
    	} 
    	
    	.Hide {
    		dispay:none;
    		width:0px;
    		height:0px;
    	}
    		
    	.Over {
    		position:absolute;
    		background-color:#fff;
    		z-index:2000;
    		left:0px;
    		right:0px;
    		top:0px;
    		bottom:0px;
    	}
    	
    	.claro .dijitTreeExpando, .claro .dojoxGridExpandoNode {    	
			background-image:url(./img/exp.png);
    	}
    	
    	.claro .dijitTreeExpandoLeaf, .dojoxGridNoChildren .dojoxGridExpandoNode {    	
			background-image:none;
    	}
    	
    	.noClose .dijitDialogCloseIcon {
    		display:none;
    	}
    	
    	.lIcon {
    		margin: -2px 5px 0 0;    		
    	}
    	
    	.frm label {
    		float:left; 
    		width:10em; 
    		text-align:left;  
    		margin:0.8em 1.5em 0.5em 2em; 
    		color:#0C0C0C;
    	}
    	
    	.frmx label {
    		float:left; 
    		width:auto;
    		text-align:left;  
    		margin:0.8em 1.5em 0.5em 0; 
    		color:#0C0C0C;
    	}
    	
    	.frmx .dijitTextBox {
    		float:right;
    	}
    	
    	.dCnt label {
    		margin:2em 1em 0 0; 
    	}
    	
    	.frm .dijitCheckBox {
    		margin:0.7em 0 0.2em 0; 
    	}
    	
    	.frm br { 
    		clear:both; 
    	}
		
		.clr {
			clear:both;
			height:0px;
		}
		
		.fInf {
    		background-color: #F2F5FF;
    		border: #769DC0 1px solid;
    		border-right:none;
			float:left;
			margin-top:25px;
			padding:8px 15px 8px 8px;
    		color:#0D3A7B; 
    		font-weight:bold; 
		}
		
		.bframe, .if {
			width:100%;
			height:100%;
                        border:none;
                        overflow:hidden;
		}
	</style>
	<script type="text/javascript" src="./release/dojo/dojo.js.uncompressed.js" charset="utf-8"
		data-dojo-config="parseOnLoad: false, baseUrl:'./',
			paths:{	appudo:'.', 
					dojo:'release/dojo', 
					dijit:'release/dijit',
					dojox:'release/dojox'
					}, 
                                isDebug:false, debugAtAllCosts:false"></script>
	<script type="text/javascript">  
		require([
			'dojo/_base/kernel',
			'dijit',
			'dojo/_base/declare',
			'dojo/i18n!appudo/nls/main',
			'dojo/on',
			'dojo/_base/xhr',
			'dojo/_base/Deferred',
			'dojo/DeferredList',
			'dojox/socket',
			'dojox/socket/Reconnect',
			
			'dojo/parser',

			'dojo/date/locale',
			'dijit/Menu',
			'dijit/ProgressBar',
			'dijit/TitlePane',
			'dijit/Tooltip',
			'dijit/Tree',
			'dijit/Toolbar',
			'dijit/ToolbarSeparator',
			
			'dojo/dnd/Source', 
			'dijit/tree/dndSource',
			
			'dijit/MenuBar',
			'dijit/MenuBarItem',
			'dijit/PopupMenuBarItem',
			'dijit/MenuItem',
			'dijit/PopupMenuItem',
			
		    'dijit/form/Form',
			'dijit/form/CheckBox',
			'dijit/form/Textarea',
			'dijit/form/SimpleTextarea',
			'dijit/form/FilteringSelect',
			'dijit/form/TextBox',
			'dijit/form/DateTextBox',	
			'dijit/form/TimeTextBox',	
			'dijit/form/Select',	
			'dijit/form/MultiSelect',	
			'dijit/form/CurrencyTextBox',	
			'dijit/form/Button',
			'dijit/InlineEditBox',
			'dijit/form/NumberSpinner',
			'dijit/form/DropDownButton',
			'dijit/form/RadioButton',		
			
			'dijit/layout/AccordionContainer',
			'dijit/layout/ContentPane',
			'dijit/layout/TabContainer',
			'dijit/layout/BorderContainer',
			'dijit/Dialog',		
			'dijit/TooltipDialog',		
			'dojo/data/ItemFileReadStore',
			'dojo/data/ItemFileWriteStore',
			'dojo/store/Memory',
			
			'dojox/grid/DataGrid',
			'dojox/grid/LazyTreeGrid',
			
		], function(dojo, dijit, declare, nls, on, xhr, defer, dlist, sock, sock_rc) {
                        Error.prototype.log = false;
			var global = dojo.global;
                        global.nls = nls;
                        global.modTree = {} // TODO remove
   			
   			var logReg = {};
   			var logStore = {}; 

			if(!window.console)
				window.console = {log:function(txt){}};
			
			dojo.addOnLoad(function() {
				appudo.initCls();
				var lo = dojo.byId('login');
				var l = dojo.query('#lfrm', lo)[0];
				dojo.parser.parse(lo)//.then(function(){
					appudo.initLFrm(l);
					l = dojo.byId('loaderInner');
					l.innerHTML = nls.lmsg;
					appudo.login('','');
				//});
			});
			
			global.tmpl = {
				form : './tmpl/form.html',
				page : './tmpl/page.html',
				welcome : './tmpl/welcome.html',
                                about : './tmpl/about.html',
				module : './tmpl/module.html',
				upload : './tmpl/upload.html',
				folder : './tmpl/folder.html',
				editor : './tmpl/editor.html',
			}
			var FWS = declare(dojo.data.ItemFileWriteStore, {
				getValueDeleted: function(item, prop){
					return item[prop];
				},
				onDeleteStart: function(item){
					
				},
				delItem: function(item){	
					this.onDeleteStart(item);
			    	this.deleteItem(item);
				},
				delById: function(id, p){
					if(p){
						this.fetch({
							query: {p:p},
							onComplete: dojo.hitch(this, function(items){
								var _this = this;
								dojo.forEach(items, function(it) {
									_this.deleteItem(it);
								});
							}),
							onError: function() {}
						});
					}					
					this.fetch({
						query: {id:id},
						onComplete: dojo.hitch(this, function(items){
							if(items.length != 0)
								this.deleteItem(items[0]);
						}),
						onError: function() {}
					});
				}
			});
			
			var FSTM = declare(dijit.tree.ForestStoreModel, {

				getChildren: function(item, onComplete, onError) {
					if(item === this.root){
						if(this.root.children){
							onComplete(this.root.children);
						}else{
							this.store.fetch({
								query: this.query,
								onComplete: dojo.hitch(this, function(items){
									this.root.children = items;
									onComplete(items);
								}),
								onError: onError
							});
						}
					}else{
						var cq = this.cquery;;
						var x = onComplete;
						var s = this.store;;
						var cb = function(items) {
							if(cq)
								items = items.filter(function(item){
									var set = true;
									for(var k in cq)
										set &= s.getValueDeleted(item, k) == cq[k];
									return set;
								});
							x(items)
						};
						onComplete = cb
				    	this.inherited(arguments);
					}
				}
			});
			
			var FLSM = declare(dijit.tree.ForestStoreModel, {
			    mayHaveChildren: function(item) {
			        return item[this.childrenAttrs[0]];
			    },
			    getChildren: function(item, onComplete, onError) {	
					if(item === this.root){
						if(this.root[this.childrenAttrs[0]]){
							onComplete(this.root[this.childrenAttrs[0]]);
						}else{
							this.store.fetch({
								onComplete: dojo.hitch(this, function(items){
									this.root[this.childrenAttrs[0]] = items;
									if(this.sort)
										items.sort(this.sort);
									onComplete(items);
								}),
								onError: onError
							});
						}
					}else{
						var items = item[this.childrenAttrs[0]];
						if(items && this.sort)
							items.sort(this.sort);
						onComplete(items);
					}
				}
			});
			
			var FSM = declare(dijit.tree.ForestStoreModel, {
				pId:'id',
				cMask:1,
			    mayHaveChildren: function(item) {
                                 return item === this.root ? true : /* this.inherited(arguments) || */ (this.store.getValue(item, 'c') & this.cMask);
			    },			
				getChildren: function(item, onComplete, onError) {	
					if(item === this.root){
						if(this.root.children){
							onComplete(this.root.children);
						}else{
							this.store.fetch({
								query: this.query,
								onComplete: dojo.hitch(this, function(items){
									this.root.children = items;
									if(this.sort)
										items.sort(this.sort);
									onComplete(items);
								}),
								onError: onError
							});
						}
					}else{
						var qry = {p: (this.store.getValue(item, this.pId))};
						if(this.cquery)
							dojo.mixin(qry, this.cquery);
						this.store.fetch({
							query: qry,
							onComplete: dojo.hitch(this, function(items){
								if(this.sort)
									items.sort(this.sort);
								onComplete(items);
							}),
							onError: onError
						});
					}
                                },
			    pasteItem : function(childItem, oldParentItem, newParentItem, bCopy, insertIndex){
			    	var store = this.store;
					if(oldParentItem === this.root && !bCopy)
						this.onLeaveRoot(childItem);
					if(newParentItem && newParentItem !== this.root)
					{
						store.setValues(childItem, 'p', store.getIdentity(newParentItem));
						this.getChildren(newParentItem,  dojo.hitch(this, function(items){
							this.onChildrenChange(newParentItem, items);
						}), this.onError);
			    	}
					if(oldParentItem && oldParentItem !== this.root && oldParentItem != newParentItem)
					{
						this.getChildren(oldParentItem,  dojo.hitch(this, function(items){
							this.onChildrenChange(oldParentItem, items);
						}), this.onError);
			    	}
					if(newParentItem === this.root)
						this.onAddToRoot(childItem); 
                                },
                                /*
				onChange : function(item){					
			    	var store = this.store;
			    	var p = store.getValue(item, 'p');
			    	
			    	if(p !== undefined){
			    		store.fetch({
							query: {id:'o'+p},
							onComplete: dojo.hitch(this, function(items){
								if(items.length == 0)
									return;
								this.getChildren(items[0],  dojo.hitch(this, function(it){
									this.onChildrenChange(items[0], it);
								}), this.onError);								
							}),
							onError: this.onError
						});
					}
				}
				*/
			});
			
			global.stores = {
                                pageStore : new FWS({url:'/edit/1/0/'}),
                                fileStore : new FWS({url:'/edit/1/1/'}),
                                userStore : new FWS({url:'/edit/1/2/'}),
                                modStore : new FWS({url:'/edit/1/3/'}),
                                dataStore : new FWS({url:'/edit/1/J/'})
			}
			
			var sorter = function(s) {return function(a,b){
				var at = s.getValue(a, 't');
				var bt = s.getValue(b, 't');
				if(at == bt) {
					return s.getValue(a, 'l').localeCompare(s.getValue(b, 'l'));
				} else {
					return at > bt ? 1 : -1;
				}
			}}; 
			
			global.models = {
                                pageModel : new FSTM({store:stores.pageStore, query:{id:'0'},
							rootId:'root', childrenAttrs:['c']}),
				fileModel : new FLSM({store:stores.fileStore,
								rootId:'root', childrenAttrs:['c'], newItemIdAttr:null, sort:sorter(stores.fileStore)}),
                                userModel : new FSM({store:stores.userStore, query:{id:'0'},
								rootId:'root', sort:sorter(stores.userStore)}),
                                modModel : new FSM({store:stores.modStore, query:{id:'0'},
								rootId:'root', sort:sorter(stores.modStore)}),
                                dataModel : new FSM({store:stores.dataStore, query:{id:'0'},
								rootId:'root', sort:sorter(stores.dataStore)})
			}
			global.appudo = {
				ForestStoreModel: FSM,
				xhr:xhr,
				tasks:0,
				rdy:false,
				modal:false,     
				defer:defer,
                                _cache:{},
                                hide : function(dom) {
                                    dojo.style(dom, 'display', 'none');
                                },
                                show : function(dom, v) {
                                    dojo.style(dom, 'display', v);
                                },
                                toStr10 : function(v) {
                                        var tmp = "000000000";
                                        var LOG_BASE = 8;
                                        var r = "",
                                            i = 0,
                                            j, k = v.length;
                                        for(; i < k; i++) {
                                            j = String(v[i]);
                                            r = j + r;
                                            if(i != k - 1 && j.length < LOG_BASE)
                                                r = tmp.substr(0, LOG_BASE - j.length) + r;
                                        }
                                        return r;
                                },
                                gte10 : function(a, b) {
                                    var i = 0,
                                        k = a.length;
                                    if(a.length < b.length)
                                        return false;

                                    for(; i < k; i++) {
                                        if(a[i] < b[i])
                                            return false;
                                    }
                                    return true;
                                },
                                rebase : function(str, from, to){
                                    var s = str.toString().split(''), out = [], i, c
                                    while(s.length){
                                        c = parseInt(s.shift(), from);
                                        for(i = 0; c || i < out.length; i++){
                                            c += (out[i] || 0) * from;
                                            out[i] = c % to;
                                            c = (c - out[i]) / to;
                                        }
                                    }
                                    for(i = 0; i < out.length; i++){
                                        out[i] = out[i].toString(to);
                                    }
                                    out.reverse();
                                    return out.join('');
                                },
                                split10 : function(v) {
                                        var LOG_BASE = 8;
                                        var r = [],
                                            max = v.length,
                                            min = max - LOG_BASE;
                                        while(max > 0) {
                                            r.push(+v.slice(min, max));
                                            min -= LOG_BASE;
                                            if(min < 0) min = 0;
                                                max -= LOG_BASE;
                                        }
                                        return r;
                                },
                                mask1032 : function(a) {
                                    if(a.length <= 8)
                                        return ""
                                    return appudo.rebase(appudo.rebase(a, 10, 16).slice(8, 0), 16, 10);
                                },
                                shift1032 : function(a) {
                                    if(a.length <= 8)
                                        return "";
                                    return appudo.rebase(appudo.rebase(a, 10, 16).slice(0, -8), 16, 10);
                                },
                                sub10 : function(a, b) {
                                        var BASE = 1e8;
                                        var a_l = a.length,
                                            b_l = b.length,
                                            r = new Array(a_l),
                                            borrow = 0,
                                            base = BASE,
                                            i, difference;
                                        for (i = 0; i < b_l; i++) {
                                            difference = a[i] - borrow - b[i];
                                            if (difference < 0) {
                                                difference += base;
                                                borrow = 1;
                                            } else
                                                borrow = 0;
                                            r[i] = difference;
                                        }
                                        for (i = b_l; i < a_l; i++) {
                                            difference = a[i] - borrow;
                                            if(difference < 0)
                                                difference += base;
                                            else {
                                                r[i++] = difference;
                                                break;
                                            }
                                            r[i] = difference;
                                        }
                                        for(; i < a_l; i++) {
                                            r[i] = a[i];
                                        }
                                        var i = r.length;
                                        while(r[--i] === 0);
                                            r.length = i + 1;
                                        return r;
                                },
				on : function(target, event, scope, fkt) { 
					if(!fkt) {
						fkt = scope;
						scope = null;
					}
					if(scope) 
						fkt = dojo.hitch(scope, fkt);
					return on(target, event, fkt);
				},
				parseFileList : function(list, cb) {
					var l = [];
					for(var i = 0, len = list.length; i < len; i++) {
						if(list[i].webkitGetAsEntry && list[i].kind=='file') {
							var item = list[i].webkitGetAsEntry();
							if(item)
								l.push(appudo.parseFiles(item, null, cb));
						}
					}
					return new dlist(l);
				},
				findNStr : function nthIndex(str, v, num){
				    var len = str.length, i = -1;
				    while(num-- && i++ < len){
				        i = str.indexOf(v, i);
				    }
				    return i;
				},
				jsonEscape : function(txt, start, end) {
					var l = txt.length;
					var i = start;
					var o = "";
					var last = '';
					if(start != 0)
						o = txt.substr(0, start);
					for(;i < end; i++)
					{
						var c = txt.charCodeAt(i);
						switch(c)
						{
							case 34:
								if(last != 92)
									o += '\\"';
								else
									o += '"';
							break;
							case 92:
								o += '\\';
							break;
							case 47:
								o += '\/';
							break;
							case 8:
								o += '\\b';
							break;
							case 12:
								o += '\\f';
							break;
							case 10:
								o += '\\n';
							break;
							case 13:
								o += '\\r';
							break;
							case 9:
								o += '\\t';
							break;
							default:
								o += String.fromCharCode(c);
							break;
						}
						last = c;
					}
					if(end != l)
						o += txt.substr(end, l - end);
					return o;
				},
				updateLog : function() {
					appudo.objEach(logStore, function(prop) {
						if(logReg[prop] != undefined) {
							logReg[prop](logStore[prop]);
							delete logStore[prop];
						}
					});
				},
				regLog : function(module, cb) {
					logReg[module] = cb;
					appudo.updateLog();
				},
				unregLog : function(module) {
					delete logReg[module];
				},
				parseFiles : function(item, folder, cb) {
					folder = folder || '';
					var d = new defer();
					if(item.isFile) {
						item.file(function(file) {
							cb(file, folder);
							d.resolve();
						}, function(){
							d.cancel();
						});
					} else 
					if(item.isDirectory) {
						var rd = item.createReader();
						rd.readEntries(function(items) {
							if(items.length == 0)
								cb(null, folder);
							var l = [];
							for(var i = 0, len = items.length; i< len; i++)
					        	l.push(appudo.parseFiles(items[i], folder + item.name + '/', cb));	
							var dl = new dlist(l)
							dl.then(function(){
								d.resolve();
					        })
						}, function(){
							d.cancel();
						});
					}
					return d;
				},
				start : function() {
					var b = dojo.body();
					var s = fileTree.dndController;
					function c(e) {
						if(appudo.indrag)
							s.stopDragFile();
						appudo.indrag = false;
						appudo.cancel(e);
					}
					appudo.on(b, 'dragenter', function(e){
						appudo.cancel(e);
					});
					appudo.on(b, 'dragover', function(e){
						appudo.cancel(e);
						var t = e.dataTransfer.types;
						if(appudo.indrag || !t || t[0] != 'Files')
							return;
						appudo.indrag = true;
						s.startDragFile();
						var d = appudo.on(b, 'drop', function(e){
							appudo.cancel(e);
							var items = e.dataTransfer.items;
							var files = e.dataTransfer.files;
							s.dropFile(items.length === files.length ? items : files);
							d.remove();
							c(e);
						});
						var m = appudo.on(b, 'mouseover', function(e){
							m.remove();
							c(e);
						});
					});
				},
				cancel : function(e) {
					/*
			    	if(e.stopPropagation)
			    		e.stopPropagation();
			    	e.cancelBubble = true;
			    	*/
			    	if(e.preventDefault)
			    		e.preventDefault();
			    	return false;
			    },
				onLoginErr : function() { 
				},
				logout : function() {
                                        appudo.postPlain('/edit/;', 'o=2');
					loginDlg.show();
				},
                                login : function(n, p) {
                                        if(location.protocol !== 'https:') {
				 	    window.location = location.href.replace('http:', 'https:')
                                            return;
                                        }
					dojo.xhrPost({
                                                url : '/edit/;',
						handleAs: 'json',	
						failOk:true,						
						content:{n:n,p:p},
						load : function(response, ioArgs) {
							if(response && response.r == 0) {
								appudo.onLogin(response);
							} else {
								if(!appudo.rdy)
									loginDlg.show();
								appudo.onLoginErr();
							}
						},
						error : function(){
							if(!appudo.rdy)
								loginDlg.show();
							appudo.onLoginErr();
						}
                                        });
				},
				onLogin : function(response) { 	
					if(response && response.r == 0) {
                                                appudo.aid = response.d;
						if(!appudo.rdy)
						{
							appudo.rdy = true;
							dojo.parser.parse(dojo.byId('container'))//.then(function(){
								setTimeout(function hideLoader() {
									dojo.fadeOut({ 
										node: 'loader', 
										duration:500,
										onEnd: function(n){
											if(typeof WebSocket == "undefined")
												console.log("ws error")
											n.style.display = 'none';
                                                                                        mainTab.init();
                                                                                        appudo.openTab(tmpl.welcome, nls.welcome, 'iW');
                                                                                        var tab = appudo.openTab(null, nls.welcome, 'iW');
                                                                                        dojo.style(tab.controlButton.domNode, 'visibility', 'hidden');
                                                                                        setTimeout(function() {
                                                                                            mainTab.removeChild(tab);
                                                                                        }, 0);
											appudo.start();
                                                                                        try {
                                                                                            var socket = new sock_rc(new sock(args = {
                                                                                                url:'/edit/9/1/0',
                                                                                                failOk:true
                                                                                            }));
                                                                                            socket.on("message", function(m){
                                                                                                var d = m.data;
                                                                                                var v = dojo.fromJson(appudo.jsonEscape(d, appudo.findNStr(d, '"', 9)+1, d.length - 2));
                                                                                                if(logStore[v.m] == undefined)
                                                                                                        logStore[v.m] = [];
                                                                                                logStore[v.m].push(v);
                                                                                                appudo.updateLog();
                                                                                            });
                                                                                        } catch(e) {
                                                                                        }
                                                                                        setInterval(function(){
                                                                                                appudo.postPlain('/edit/;', 'o=1');
                                                                                        },120000);
										}
									}).play();
								}, 250); 
							//});
						}
					}
					else
					{
						appudo.onLoginErr();
						return false;
					}
					return true;
				},
				relogin : function() { 
					window.location = './index.html';
				},
                                cache : function(key, data, onErr) {
					var _cache = appudo._cache;
					if(data !== undefined) {
						var d = new defer();
						_cache[key] = data == null ? undefined : data;
						d.resolve(data);	
						return d;
					}
					else
					if(_cache[key] === undefined) {
                                                return appudo.getPlain(key, onErr).then(function(d){return _cache[key] = d});
					} else {
						var d = new defer();
						d.resolve(_cache[key]);
						return d;
					}
				},
				random : function(min, max) {
					if(min === undefined && max === undefined){
						min = 0;
						max = 2147483647;
					}
					return min + parseInt(Math.random() * (max-min));
				},
				checkLogin : function() { 	
                                        var url = '/edit/0/';
					appudo.cache(url);
					appudo.cache(url, null);
				},
				search : function(e) {
					if(e)
						e.preventDefault();
					var v = searchFrm.get('value');
					var d = appudo.fEdit;
					if(!d)
						return;
					try {
						if(idx === undefined)
							idx = 0;
					}catch(e){
						idx = 0;
					}
					switch(idx) {
					case 0:
						d.findNext(v.search);
						break;
					case 1:
						d.replace(v.repl);
						break;
					case 2:
						d.replaceNext(v.search, v.repl);
						break;
					case 3:
						d.replaceAll(v.search, v.repl);
						break;
					}
				},
				getViewFile : function(module, view) { 
					return '/edit/5/'+module+'/'+view+'/';
				},
				getCodeFile : function(module, view) {
					return '/edit/6/'+module+'/'+view+'/';
				},
                                getView : function(module, view, ticket, onErr) {
					var f = appudo.getViewFile(module, view);
                                        return appudo.getPlain(f + ticket, onErr).then(function(d){
						appudo.cache(f, d);
						return d;
					});
				},
                                getCode : function(module, view, ticket, onErr) {
					var f = appudo.getCodeFile(module, view);
                                        return appudo.getPlain(f + ticket, onErr).then(function(d){
						appudo.cache(f, d);
						return d;
					});
				},
				updateView : function(module, view, newText) {
					return appudo.cache(appudo.getViewFile(module, view), newText);
				},
				updateCode : function(module, view, newText) {
					return appudo.cache(appudo.getCodeFile(module, view), newText);
				},
				intToCheck : function(v) { 
					return v == 1 ? ['on'] : [];
				},
				checkToInt : function(v) { 
					return v && v.length != 0 ? 1 : 0;
				},
				showError : function(msg) { 
			  		var item = dojo.query('.dijitDialogPaneContentArea', errDlg.domNode)[0];
					item.innerHTML = msg;
					errDlg.show();
				},		
				addTask : function(msg) { 
					var _this = this;
					this.tasks++;
					setTimeout(function() {
						if(_this.tasks == 1)
                                                        appudo.show(ltask.domNode, 'inline');
					}, 200);
					return function() {
						_this.tasks--;
						if(_this.tasks == 0)
                                                        appudo.hide(ltask.domNode);
						return msg;
					}
				},						
				onError : function(response, ioArgs, rem)  {
					var msg = null;
					try {
						msg = dojo.fromJson(ioArgs.xhr.responseText);
					} catch(e) {
						
					}
					if(msg){
						appudo.errNls().then(function(n){
							var r = msg.r - 1;
							if(r < 0 || r > n.backend.length)
								r = 0;
							appudo.showError(n.backend[r]);
						})
					}
					if(rem)
						rem();
				},				
				hasValues : function(item, values) {
					values.forEach(function(prop) {
						if(item[prop] === undefined)
							return false;
					});
					return true;
				},
				fileType : function(f) { 
					var x = -1;
					var t = 0;
					if((x = f.lastIndexOf('.')) != -1)  {
						ext = f.substr(x+1, f.length); 
						ext = ext.toLowerCase();
						switch(ext) {
						case 'pdf':
							t = 1;
							break;
						case 'html':
							t = 2;
							break;
						case 'css':
							t = 3;
							break;
						case 'js':
							t = 4;
							break;
						case 'gif':
						case 'jpg':
						case 'jpeg':
						case 'png':
						case 'svg':
						case 'ico':
							t = 5;
							break;
						}
					}
					return t;
				},
				fileClass : function(idx) { 
					var fi = ['iFile', 'iPDF', 'iHTML', 'iCSS', 'iCode', 'iIMG'];
					return fi[idx];
				},
				fileIcon : function(f) { 
					return appudo.fileClass(appudo.fileType(f));
				},
				loadNls : function(name, nls) {
					var d = new defer();
					if(!global[name]) {
						require([
							nls
						], function(n) {
							var global = dojo.global;
							global[name] = n;
							d.resolve(n);	
						});
					}
					else
					{
						d.resolve(global[name]);	
					}
					return d;
				},
				modNls : function() {
					return this.loadNls('modNls', 'dojo/i18n!appudo/nls/module');
				},
				errNls : function() {
					return this.loadNls('errNls', 'dojo/i18n!appudo/nls/error');
				},
				editNls : function() {
					return this.loadNls('editNls', 'dojo/i18n!appudo/nls/editor');
				},
				addStores : function(s, target) {
					var t = target ? target : stores;
					if(s)
						t = dojo.mixin(t, s);
				},
				
				addModels : function(m, target) {
					var t = target ? target : models;
					if(m)
						t = dojo.mixin(t, m);
				},
				
				showMenuItem : function(item, hide) {
                                        if(hide)
                                                appudo.hide(item.domNode);
					else
                                                appudo.show(item.domNode, 'table-row');
				},
				
				addTmpl : function(l, target) {
					var t = target ? target : tmpl;
					if(l)
						t = dojo.mixin(t, l);
				},
				
				printf : function (fmt, args) {
				    var i = 0;
				    return fmt.replace(/%((%)|s)/g, function (d) { return d[2] || args[i++] })
				},

				gridFmt : function(cls, fkt) {
					if(!fkt)
						return function(value, idx) {
							return '<span class="'+(cls)+' appudoIcon">'+value+'</span>';
						};
					else
						return function(value, idx) {
							return '<span class="'+fkt(value, true)+' appudoIcon">'+fkt(value)+'</span>';
						};
				},

                                getPlain : function(url, onErr) {
                                        var d1 = new defer();
					var r = appudo.addTask('');
                                        onErr = onErr || function() {}
					var get = {
						url: url,  
						handleAs:'text',
                                                headers: {'Content-Type': 'text/plain;charset=UTF-8'},
                                                error: function(res, a){d1.cancel();onErr();appudo.onError(res, a, r)},
                                                load : function(response, ioArgs) {
                                                    if(ioArgs.xhr.status != 200) {
                                                        onErr();
                                                        appudo.onError(res, a, r);
                                                        d1.cancel();
                                                    } else {
                                                        d1.resolve(response, ioArgs)
                                                    }
                                                },
                                                failOk:true
					};
					var d = xhr.get(get);
                                        d.then(function(){
						r();
						return d;
                                        });
                                        return d1;
				},
				
                                postBinary : function(url, data, onErr) {
                                        var d1 = new defer();
					var r = appudo.addTask('');
                                        onErr = onErr || function() {}
					var post = {
                                            url: url,
                                            rawBody:data,
                                            handleAs:'json',
                                            headers: {'Content-Type': 'text/plain;charset=x-user-defined'},
                                            error: function(res, a){d1.cancel();onErr();appudo.onError(res, a, r)},
                                            load : function(response, ioArgs) {
                                                if(ioArgs.xhr.status != 200) {
                                                    onErr();
                                                    appudo.onError(res, a, r);
                                                    d1.cancel();
                                                } else {
                                                    d1.resolve(response, ioArgs)
                                                }
                                            },
                                            failOk:true
					};

					var d = xhr.post(post);
					d.then(function(){
						r();
						return d;
                                        });
                                        return d1;
				},
				
                                postPlain : function(url, txt, onErr) {
                                        var d1 = new defer();
					var r = appudo.addTask('');
                                        onErr = onErr || function() {}
					var post = {
                                            url: url,
                                            rawBody:txt,
                                            handleAs:'text',
                                            headers: {'Content-Type': 'text/plain;charset=UTF-8'},
                                            error: function(res, a){d1.cancel();onErr();appudo.onError(res, a, r)},
                                            load : function(response, ioArgs) {
                                                if(ioArgs.xhr.status != 200) {
                                                    onErr();
                                                    appudo.onError(res, a, r);
                                                    d1.cancel();
                                                } else {
                                                    d1.resolve(response, ioArgs)
                                                }
                                            },
                                            failOk:true
					};

					var d = xhr.post(post);
					d.then(function(){
						r();
						return d;
                                        });
                                        return d1;
				},
				
				treeFmt : function(root, lvl, v) {
					return [
						function(value, idx, level) {
							return '<span class="'+(level == 0 ? root : lvl)+' appudoIcon">'+value+'</span>';
						}, 
						function(value, idx, level) {
							return '<span class="'+lvl+' appudoIcon">'+value+'</span>';
						}
					]
				},

				focus : function(e) {	
					appudo.focusElem = e; 
				},
				
				saveFocused : function() {	
		    		var f = appudo.focusElem;
		    		if(f && f.save)
		       			f.save.apply(f);
				},
				
				objEach : function(obj, f) {
				    for(var key in obj) {
				        if(obj.hasOwnProperty(key))
				            f(key);
				    }
				},

				getDoc : function(iframe) {
					var doc;
					if(iframe.contentDocument)
						doc = iframe.contentDocument;
					else
					if(iframe.contentWindow)
						doc = iframe.contentWindow.document;
					return doc;
				},
				initLFrm : function(iframe) {
					iframe.post = false;
					var e = dojo.query('.e', loginFrm.domNode)[0];
					loginFrm._sub = function(event) {
						var v = loginFrm.get('value');
						if(v.email == '' || v.pass == '')
                                                {
                                                        appudo.show(e, 'block');
							event.preventDefault();
						}
						else
                                                {
                                                        appudo.hide(e);
                                                        appudo.hide(loginDlg.domNode);
							iframe.post = true;
						}
					}
					iframe.onload = function() {
						var doc = appudo.getDoc(this);
						var r = null;	
						if(iframe.post)
						{
							r = doc.body.textContent;
							iframe.post = false;
						}
						if(r)
						{
							var response = null;
							try {
								response = dojo.fromJson(r);
							} catch(e) {
								
							}				
							if(!appudo.onLogin(response))
                                                        {
                                                                appudo.show(loginDlg.domNode, 'block');
                                                                appudo.show(e, 'block');
								var c = loginFrm.getChildren();
								var a = c[0];
								var b = c[1];
								b.reset();
								/*
								a.focus();
								var ov = a.validator;
								a.validator = function() {return false;}
								a.validate();  
								a.validator = ov;
								*/
							}
							else
							{
								loginDlg.hide();
							}

						}
					}
				},
				initEdit : function(ctx, iframe, mode) {
					var doc = appudo.getDoc(iframe);
					var go = function() {
						var docCtx = doc.init(mode);
				    	docCtx.save = ctx.save;
				    	docCtx.textChanged = docCtx.fullUndo = ctx.updateTitle;
				    	if(docCtx.textChanged == undefined)
				    		docCtx.textChanged = function(){}
				    	docCtx.onFocus = function(d) {
				    		appudo.fEdit = d;
				    	}
				    	docCtx.onBlur = function(d) {
				    		if(appudo.fEdit == d)
				    			appudo.fEdit = null;
				    	}
				    	docCtx.onSearch = function(sel) {
				    		searchDlg.show();
				    		if(sel != null) {
					    		var v = searchFrm.get('value');
					    		v.search = sel;
					    		searchFrm.set('value', v);
				    		}
				    	}
				    	ctx.initEdit();
					}
					iframe.onload = function() {
						if(doc.init)
							go();
						else
							doc.go = go;
					}
					function w(txt) {
						doc.writeln(txt);
					}
					doc.open();
					doc.writeln('<!DOCTYPE HTML><html lang="en"><head>');
					doc.writeln('<script type="text/javascript" charset="utf-8">');
					return appudo.cache('./ace/build/src/ace.js').then(w).then(function(){
						doc.writeln('ace.config.set("workerPath", "./ace/build/src/")'); 
						var d = new dlist([
                                                        appudo.cache('./ace/build/src/mode-swift.js').then(w),
							appudo.cache('./ace/build/src/mode-javascript.js').then(w),
							appudo.cache('./ace/build/src/mode-html.js').then(w),
							appudo.cache('./ace/build/src/mode-css.js').then(w),
							appudo.cache('./ace/build/src/theme-dawn.js').then(w)]);
						return d.then(function() {
							doc.writeln('<\/script>');
							return appudo.cache('./tmpl/editjs.html').then(w).then(function(){doc.close()});
						});
					});
				},
				initCls : function() {
					
					var ctrl = {
						_itemPages:[],
						_itemHooks:[],
						getHook : function(type) {
							return this._itemHooks[type];
						},
						getPage : function(data) {
							var _this = this;
							return function(parent) {dojo.mixin(parent.ctx, data);return appudo.cache(_this._itemPages[data.type])};
						},
						selStr : function(selection) {
							var _this = this;
							var nodes = [];
							var model = this.model;
							var store = model ? model.store : this.store; 

							if(this.treeModel) {
								dojo.forEach(selection, function(entry, i) {
									nodes.push(store.getIdentity(entry));
								});
							} else {
								if(store.dInf !== undefined)
									dojo.forEach(selection, function(entry, i) {
										nodes.push(store.getValue(entry, store.dInf));
									});
								else
									dojo.forEach(selection, function(entry, i) {
										nodes.push(store.getIdentity(entry));
									});									
							}
							var str = dojo.toJson(nodes);
							str=  '{' + str.substr(1, str.length-2) + '}';
							return str;
						},						
						addItem : function(call, data, node, ins) {
							var _this = this;
							var ctx = this.ctx;
							if(!ins)
								ins = this.insPnt();
							appudo.blockItems(this);
							var rem = appudo.addTask('');
							dojo.xhrPost({
                                                                url : '/edit/0' + (ctx ? '/' + ctx.iid : ''),
								handleAs: 'json',
								failOk:true,					
								content:dojo.mixin({c:call}, data),
								load : function(response, ioArgs) {
									if(response && response.r == 0) {
										var m = _this.model;
										var s = m ? m.store : _this.store;
										var i = {}
										if(s.idInf)
										{
                                                                                        i[s.idInf] = response.d;
										}
										else
										{
                                                                                        i.id = response.d;
										}
										var n = _this.ins(dojo.mixin(node, i), ins);
									} else {
										_this._onError(null, response, ioArgs);
									}
									rem();
									appudo.blockItems(_this, false);
								},
								error : dojo.hitch(_this, _this._onError, rem)
							});
						},						
						_onError : function(rem, response, ioArgs)  {
							appudo.blockItems(this, false);
							appudo.onError(response, ioArgs, rem);
						},						
						delItem : function(call, data, selected) {	
							appudo.blockItems(this);
							var _this = this;
							var ctx = this.ctx;
							var model = this.model;
							var store = model ? model.store : this.store;
							if(!selected)
								selected = this.selTop();
                                                        var s = this.getSelection();
							var rem = appudo.addTask('');
							dojo.xhrPost({
                                                                url : '/edit/0' + (ctx ? '/' + ctx.iid : ''),
								handleAs: 'json',
								failOk:true,
								content:dojo.mixin({c:call, n:this.selStr(selected)}, data),
								load : function(response, ioArgs) {
									if(response && response.r == 0) {
										dojo.forEach(mainTab.getChildren(), function(i) {
											var j = i.ctx ? i.ctx.openRef : null;
											if(j && dojo.indexOf(s, j) != -1) 
												mainTab.removeChild(i);
										});
										_this.clearSelection(true);
										dojo.forEach(selected, function(entry, i) {
											store.delItem(entry); 
										});
										
										store.save({onComplete: appudo.saveDone, onError: appudo.saveFailed});
									} else {
										_this._onError(null, response, ioArgs);
									}
									rem();
									appudo.blockItems(_this, false);
									return response;
								},
								error : dojo.hitch(_this, _this._onError, rem)
							});
						},							
						askDeleteItem : function(call, target, node, data) {
							var _this = this;
							var sel = this.selTop();
							if(sel.length == 0) 
								return;
							var root = node(sel[0]);
							if(!target)
								target = root.iconNode;
							appudo.ask(nls.delItems, target, {onOk:function() {_this.delItem(call, data, sel)}}); 
						
						},
						askUpload : function(target) {
							var root = this.insPnt();
							if(root.node) {
								var model = this.model;
								var store = model ? model.store : this.store;  
								var node = root.node;
								if(store.getValue(node.item, 't') != 0)
								{
									this.clearSelection();
									root = this.insPnt();
									node = root.node;
								}
								target = node.iconNode;
								dojo.window.scrollIntoView(node.iconNode);
								appudo.ask(nls.upFile, target, {before:appudo.askAddUpload(this, this.absName(node), root)});						
							}
						}
					}
					
					var grid = 
					{ 
						dndSource:null,
						_dndTarget:null,
						dndTarget:false,
						noDataMessage:nls.gridEmpty,
					    createManagers : function() {
					    	this.inherited(arguments);
					    	this.focus.focusClass = '';
					    },
						onFetchError: function(err, ioArgs){
							appudo.checkLogin();
						},
					    onStyleRow : function(inRow) {
							this.styleRowState(inRow);
					    	inRow.customClasses += (inRow.odd?' dojoxGridRowOdd':'') + (inRow.selected?' dojoxGridRowSelected':'');
							this.focus.styleRow(inRow);
							this.edit.styleRow(inRow);
					    },
					    onCellContextMenu : function(e) {
					    	if(e.rowNode) {
						    	var _this = this;
						    	var item = this.getItem(e.rowIndex);
				  				this.menu.isOpen = true;
								this.selection.select(e.rowIndex);
								gridMenu.grid = this;
								gridMenu.data = item;
							} 
						},
						onCellDblClick: function(e)
						{
							if(e.rowNode){
								var item = this.getItem(e.rowIndex);
								var call = this.ed ? this.ed[e.cellIndex] : null;
								var m = this.treeModel;
								var s = m ? m.store : this.store;
								var n = {};
								var c = this.getCell(e.cellIndex)
								dojo.forEach(s.getAttributes(item), function(attr) {
									n[attr] = s.getValue(item, attr);
								});
								if(this.treeModel && n.p === undefined)
									return;
								if(call)
									this.askEdit(dojo.mixin({x:e.clientX,y:e.clientY},dojo.hitch(this, call)(s, item, n)), c.name);
							}
						},
				        askEdit : function(d, cname){ 
				        	if(!appudo.hasValues(d, ['t', 'c', 'value', 'field', 'x', 'y', 'post', 'onOk']))
				        		return;
				        	var _this = this;
				        	var ctx = this.ctx;
				        	var b;
				        	if(d.t == 0) 
				        		b = appudo.askAddText(d.value, d.r);
				        	if(d.t == 1) 
				        		b = appudo.askAddCheck(d.value);
				        	if(d.t == 2) 
				        		b = appudo.askAddText(d.value, false, '^0|([1-9][0-9]{0,9})$', nls.pos);
				        	if(d.t == 3) 
				        		b = appudo.askAddText(d.value, true, '^0|([1-9][0-9]{0,9})$', nls.pose);
				        	if(d.t == 4)
                                                        b = appudo.askAddSelect(d.r, d.value);
				        	appudo.ask(nls.updC + ' ' + cname, null, {
							before:b, x:d.x, y:d.y,
							onOk:function(v, data) {
								var x = {};
								if(dojo.isArray(v.value)) {
									x[d.field] = v.value.length == 0 ? 0 : v.value ? 1 : 0;
									if(x[d.field] == (d.value ? 1 : 0))	
										return;
								} else {
									if(d.t == 1 && Boolean(v.value) == Boolean(d.value))
										return;
									x[d.field] = v.value;	
								}
								if(v.value == d.value)
									return;	
								if(d.r && v.value == '')
									x[d.field] = -1;
					        	dojo.xhrPost({
                                                                        url : '/edit/0' + (ctx ? '/' + ctx.iid : ''),
									handleAs: 'json',
									failOk:true,					
									content:dojo.mixin({c:d.c},dojo.mixin(d.post, x)),
									load : function(response, ioArgs) {
										if(response && response.r == 0) {
											d.onOk(v, data);
										} else {
											_this._onError(null, response, ioArgs);
										}
									},
									error : dojo.hitch(_this, _this._onError, null)
								});
							}}); 
				        }, 
				        onOk : function() {	
				        	
				        }, 
						_onError : function(rem, response, ioArgs)  {
							appudo.onError(response, ioArgs, rem);
						},			
						sort : function() {	
			    			this.clearSelection();
					    	this.inherited(arguments);
						},
						selTop : function() {	
							var selection = [];
							var select = this.selection.getSelected();
							var _this = this;
							var store = this.store;
							if(this.treeModel) {
								dojo.forEach(select, function(entry, i) {
									if(store.getValue(entry, 'p') !== undefined)
										selection.push(entry);
								});
							} else {
								selection = select;
							}
							return selection;
						},
						defP : function() {
							return page.ctx.gParent || '';
						},
						insPnt : function(type) {
							var cmt
							if(this.insCtm && (cmt = this.insCtm()))
								return cmt;
							var sel = this.selection.getSelected();
							var result = {};
							var item;
							var node;
							var model = this.treeModel;
							var store = model ? model.store : this.store;  
							if(model && sel.length != 0) {
								item = sel[0];
								node = getNodesByItem(item)[0];
								if(type !== undefined && store.getValue(item, 't') != type) 
									item = node.getParent();
							}
							if(item) 
								result.nodeId = model && model.pId ? store.getValue(item, model.pId) : store.getIdentity(item);
							else
								result.nodeId = this.defP();
							result.pInfo = {parent:item};
							return result;
						},
						add : function(call, parent, name) { 
							var post = {l:name};
							if(parent !== undefined)
								post = dojo.mixin({m:parent}, post);
							this.addItem(call, post, {l:name, p:null});
						},
						addData : function(call, parent, name, data) {
							var post = {l:name};
							if(parent !== undefined)
								post = dojo.mixin({m:parent}, post);
							post = dojo.mixin(post, data);
							if(data.noname !== undefined)
								delete post.l;
							var ins = data.p !== undefined ? {nodeId:data.p} : null;
							if(ins)
								delete post.p;
							this.addItem(call, post, dojo.mixin({l:name},data),ins);
						},
						addSubData : function(call, name, p, n, d, inst) {
							var ins = this.insPnt();
							if(this.treeModel && ins.nodeId == '')
								return;
							var post = {v:ins.nodeId, l:name};
							var node = {l:name, p:ins.nodeId};
							var nn;
							if(p !== undefined)
								post = dojo.mixin(p, post);
							if(n !== undefined)
								node = dojo.mixin(n, node);
							if(d !== undefined){
								nn = d.noname;
								delete d.noname;
								node = dojo.mixin(node, d);
								post = dojo.mixin(post, d);
							}
							if(nn)
								delete post.l;
							this.addItem(call, post, node, ins);
						},
						getIns : function(id) {
							return {nodeId:id, pInfo:{parent:this.getItem('o'+id)}};
						},
						addSub : function(call, name, p, n, ins) {
							if(ins === undefined)
								ins = this.insPnt();
							else
								ins = this.getIns(ins);
							if(this.treeModel && ins.nodeId == '')
								return;
							var post = {v:ins.nodeId, l:name};
							var node = {l:name, p:ins.nodeId};
							if(p !== undefined)
								post = dojo.mixin(p, post);
							if(n !== undefined)
								node = dojo.mixin(n, node);
							this.addItem(call, post, node, ins);
						},
						ins : function(args, insPnt) {
							args.p = insPnt.nodeId;
							var item = this.store.newItem(args, insPnt.pInfo); 
							this.store.save({onComplete: appudo.saveDone, onError: appudo.saveFailed});
							setTimeout(dojo.hitch(this, this.scrollToItem, item), 20);
						},
						scrollToItem : function(item) {
							var idx = this.getItemIndex(item);
							this.selection.select(idx);
							this.scrollToRow(idx);
						},
						clearSelection : function() {
							this.selection.select(-1);
						},
						getSelection : function() {
							return this.selection.getSelected();
						},
						askDelete : function(call, target) { 
							var _this = this;
							if(!call)
								call = this.delCall;
							this.askDeleteItem(call, target, function(node){
								var row = _this.getRowNode(_this.getItemIndex(node));
								var n = dojo.query('.appudoIcon', row)[0];
								if(!n)
									n = dojo.query('.dojoxGridCell', row)[0];
								return {iconNode:n};
							});
						},
					    postCreate : function(args, frag) {	
					    	if(this.onInit)
					    		dojo.hitch(this, this.onInit)();
					    	this.inherited(arguments);
					    	this.menu = gridMenu;
						    this.menu.bindDomNode(this.domNode);
						    appudo.on(dijit.getEnclosingWidget(this.domNode.parentNode), 'blur', this, function() {
					      		if(!appudo.modal && !this.menu.isOpen)
					    			this.clearSelection();
							});
					    },
					    canDrop: function(s, item, nodes){
							var type = s.getValue(item, 't');
					    	return nodes.length == 1 && type == 1;
						},
					    addDrop: function(stree, node, target, coords){
						},
						addDropError: function(stree, type, num, target){
						},
						postrender: function(){
					    	this.inherited(arguments);
							if(this.focus.focusView && this.focus.focusView instanceof dojox.grid._RowSelector)
								dojo.addClass(this.focus.focusView.scrollboxNode, 'Selector');
						},
						clearItems: function() {
						},
						createView: function(inClass, idx){
					    	var v = this.inherited(arguments);
					    	var grid = this;
					    	if(this.dndTarget){
					    		/*
								if(this._dndTarget){
									this._dndTarget.destroy();
									delete this._dndTarget;
								}
								*/
								this._dndTarget = new appudo.dndTreeTarget(this.viewsNode.firstChild, {
									destroy: dojo.hitch(this, function(){
										dojo.dnd.Source.prototype.destroy.call(this);		
									}),
									onDropExternal: function(source, nodes, copy){
										var dnode = nodes[0];
										var t = source.getItem(dnode.id);
										var tree = source.tree; 
										var node = dijit.getEnclosingWidget(dnode);
										var m = tree.model;
										var s = m.store;
										var tnode = this.targetRowIdx == -1 ? null : grid.getItem(this.targetRowIdx);
										var inP = !grid.treeModel || tnode != null
										var item = node.item;
										var type = s.getValue(item, 't');
										inP = !inP || !grid.canDrop(s, node.item, nodes);
										
										if(grid.treeModel)
											grid.selection.select(this.targetRowIdx);
										s = grid.store;
										var tn = {};
										if(tnode) {
											dojo.forEach(s.getAttributes(tnode), function(attr) {
												tn[attr] = s.getValue(tnode, attr);
											});
										}
										if(inP){
											dojo.hitch(grid, grid.addDropError)(tree, type, nodes.length, tn);
											return;
										}										
										dojo.hitch(grid, grid.addDrop)(tree, node, tn, this.targetCoords);
									},	
									onMouseUp: function(e){
										if(this.isDragging){
											var node = dijit.getEnclosingWidget(e.target);
											v.doContentEvent(e);
											this.targetRowIdx = e.rowIndex === undefined ? -1 : e.rowIndex ;
											this.targetCoords = {x:e.pageX, y:e.pageY};
										}
										dojo.dnd.Source.prototype.onMouseUp.call(this._dndTarget, e);
									},
								});
								if(this.dndSource == null)
									this.dndSource = fileTree;
								this._dndTarget.sourceTree = this.dndSource;
					    	}
							return v;
						}
					}
					dojo.dnd.Manager.extend({
						startDrag: function(source, nodes, copy, drag){
							this.source = source;
							this.nodes  = nodes;
							this.copy   = Boolean(copy);
							this.avatar = this.makeAvatar();
							dojo.body().appendChild(this.avatar.node);
							dojo.publish('/dnd/start', [source, nodes, this.copy]);
							var _this = this;
							this.events = [];
							var docs = [dojo.doc]
							for(var i=0; i<frames.length; i++)
								docs.push(frames[i]);
						    dojo.forEach(docs, function(doc){
						    	if(drag)
							    	_this.events.push(
											dojo.connect(doc, 'dragover', _this, 'onMouseMove'),
											dojo.connect(doc, 'ondrop',   _this, 'onMouseUp'));
						    	_this.events.push(
								dojo.connect(doc, 'onmousemove', _this, 'onMouseMove'),
								dojo.connect(doc, 'onmouseup',   _this, 'onMouseUp'),
								dojo.connect(doc, 'onkeydown',   _this, 'onKeyDown'),
								dojo.connect(doc, 'onkeyup',     _this, 'onKeyUp'),
								dojo.connect(doc, 'ondragstart',   dojo.stopEvent));
							});
						    this.events.push(dojo.connect(dojo.body(), 'onselectstart', dojo.stopEvent));
							var c = 'dojoDnd' + (copy ? 'Copy' : 'Move');
							dojo.addClass(dojo.body(), c);
						},	
						onMouseMove: function(e){
							var a = this.avatar;
							if(a){
								dojo.dnd.autoScrollNodes(e);
								var s = a.node.style;
								var w = e.view.frameElement;
								var o = w ? dojo.position(w) : {x:0, y:0};
								s.left = (e.pageX + o.x + this.OFFSET_X) + 'px';
								s.top  = (e.pageY + o.y + this.OFFSET_Y) + 'px';
								var copy = Boolean(this.source.copyState(dojo.isCopyKey(e)));
								if(this.copy != copy){
									this._setCopyStatus(copy);
								}
							}
						}
					});
					
					dojox.grid._RowSelector.extend({
						doStyleRowNode: function(inRowIndex, inRowNode){		
							var n = [ 'dojoxGridRowbar dojoxGridNonNormalizedCell' ];
							inRowNode.className = n.join(' ');
						}
					});
					appudo.Dummy = declare([dijit._TemplatedMixin], {
                        templateString: '<div data-dojo-attach-point="containerNode"></div>'
                	}); 

					appudo.DummyCont = declare([dijit.layout._LayoutWidget, dijit.layout._ContentPaneResizeMixin], {
					
                	}); 
					appudo.Grid = declare(dojox.grid.DataGrid);
					appudo.TreeGrid = declare(dojox.grid.LazyTreeGrid);
					dojo.mixin(grid, ctrl);
					appudo.Grid.extend(grid);
					appudo.Grid.extend({
						_onNew: function(item, parentInfo){
							var set = true;  
							var cq = this.query;
							var v;
							for(var k in cq){
								v = cq[k];
								if(v == '*')
									set &= this.store.getValueDeleted(item, k);
								else
									set &= this.store.getValueDeleted(item, k) == v;
							}
							if(!set)
								return;
						    this.inherited(arguments);
						}
					});
					appudo.TreeGrid.extend(grid);
					dojox.grid._LazyTreeGridCache.extend({
						getSiblingIndex: function(rowIndex, treePath){
							if(!treePath)
								return 1;
							var i = rowIndex - 1, indexCount = 0, tp;
							for(; i >=0; i--){
								tp = this.items[i] ? this.items[i].treePath : [];
								if(tp.join('/') === treePath.join('/')){
									indexCount++;
								}else if(tp.length < treePath.length){
									break;
								}
							}
							return indexCount;
					}});
					appudo.TreeGrid.extend({
						_oldQry:null,
						_in:false,
						_inId:-1,
						_openState:null,
						insCtm : function(type) {
							if(this._in)
								return this.getIns(this._inId);
						},
						goInto : function(item) {
							var model = this.treeModel;
							var store = model.store;
							var dom = this.domNode;
							var bar = dijit.getEnclosingWidget(dom.parentNode).getChildren()[0];
							var node = dojo.create('div', {style:{display:'inline-block'}}, bar.domNode, 'first');
							dojo.place(this.fmt[0](store.getValue(item, 'l'), 0, 0), node);
							dojo.place('<span style="width:2px;display:inline-block">&nbsp;</span>', node);
							var _this = this;
							this.intoButton = new appudo.IconButton(
							{
							    iconClass:'iOut',
								title:nls.goOut,
								onClick:function() {_this.goOut.call(_this)}
							},
							dojo.create('div', null, node));	
							this._in = true;
							this._inId = store.getValue(item, model.pId);
							this.intoNode = node;	
							this.structure[0].formatter = this.fmt[1];
							this.set('structure', this.structure);
							this._oldQry = model.query; 
							this.setQuery(dojo.mixin({p:this._inId}, model.cquery));
							this.refresh();
							var parent = dijit.getEnclosingWidget(dom.parentNode);
							parent.resize();
						},
						goOut : function() {
							var dom = this.domNode;	
							this.intoButton.destroyRecursive();
							this._in = false;
							dojo.destroy(this.intoNode);
							this.structure[0].formatter = this.fmt[0];
							this.set('structure', this.structure);
							this.setQuery(this._oldQry);
							this.refresh();
							this.setOpen();
							var parent = dijit.getEnclosingWidget(dom.parentNode);
							parent.resize();
						},	
						expandoFetch: function(rowIndex, open){
							var items = this._by_idx;
							var itemId = items[rowIndex].idty;
					    	var state = this._openState || {};
					    	if(open)
					    		state[itemId] = true;
					    	else
					    		delete state[itemId];		
					    	this._openState = state;
					    	this.inherited(arguments);		
							
						},
						setOpen: function() {
							if(this._loading) {
								setTimeout(dojo.hitch(this, setOpen), 200);
								return;
							}
							var items = this._by_idx;
					    	var tc = this._treeCache;
					    	var tci = tc.items;
					    	var i = 0, len = items.length;
					    	var state = this._openState;
					    	if(!state || !tci || tci.length == 0)
					    		return;
					    	var exp = [];
							for(; i < len; i++) {	
								var it = items[i];
								if(it && state[it.idty]) {
									var rowNode = this.views.views[this.views.views.length - 1].getRowNode(i);
									if(rowNode){
										var e = dijit.findWidgets(rowNode)[0];
										if(e)
											exp.push(e);
									}									
								}
							}
							i = 0;len = exp.length;
							for(; i < len; i++) 
								exp[i].setOpen(true);
						},	
						_onFetchComplete: function(items, request){
					    	this.inherited(arguments);
							if(!this._loading && this._reqQueueLen === 0) 
						    	this.setOpen();							
						},
						_onNew: function(item, parentInfo){
							var p = this.store.getValue(item, 'p');
							var set = true;  
							var cq = this.treeModel.cquery;
							if(p !== undefined) {
								for(var k in cq)
									set &= this.store.getValueDeleted(item, k) == cq[k];
								if(!set)
									return;
							}
							var addingChild = p !== undefined;
							var items = this._treeCache.items, byIdx = this._by_idx;							
							if(!addingChild){
								items.push({opened: false, treePath: []});
								this._size += 1;
								this.inherited(arguments);
							}else{
								var parentIdty = 'o'+p,
									rowIndex = -1, i = 0;
								for(; i < byIdx.length; i++){
									if(parentIdty === byIdx[i].idty){
										var mask = this.treeModel.cMask;
										if(mask) {											
											var c = this.store.getValue(byIdx[i].item, 'c') || 0;
											if((c & mask) == 0) 
												this.store.setValue(byIdx[i].item, 'c', (c + mask));											
										}
										rowIndex = i;
										break;
									}
								}
								
								if(rowIndex >= 0){
									if(items[rowIndex] && items[rowIndex].opened){
										var parentTreePath = items[rowIndex].treePath, pos = rowIndex + 1;
										for(; pos < items.length; pos++){
											if(items[pos].treePath.length <= parentTreePath.length){
												break;
											}
										}
										var treePath = parentTreePath.slice();
										treePath.push(parentIdty);
										this._treeCache.items.splice(pos, 0, {opened: false, treePath: treePath});
										// update grid._by_idx
										var idty = this.store.getIdentity(item);
										this._by_idty[idty] = { idty: idty, item: item };
										byIdx.splice(pos, 0, this._by_idty[idty]);
										// update grid
										this._size += 1;
										this.updateRowCount(this._size);
										this._updateRenderedRows(pos);
									}else{
										var rowNode = this.views.views[this.views.views.length - 1].getRowNode(rowIndex);
										if(rowNode){
											var expando = dijit.findWidgets(rowNode)[0];
											if(expando)
												expando.setOpen(true);
										}
										this.updateRow(rowIndex);
									}
								}
							}
						},
						_onDelete: function(item){
							var p = this.store.getValueDeleted(item, 'p');
							if(p !== undefined) {
								var set = true;  
								var cq = this.treeModel.cquery;
								for(var k in cq)
									set &= this.store.getValueDeleted(item, k) == cq[k];
								if(!set)
									return; 
							}
							var pitem;
							var parentIdty = 'o'+p,
							i = 0, pIndex = -1,rowIndex = -1, idty = this.store.getIdentity(item);
							for(; i < this._by_idx.length; i++){
								var idt = this._by_idx[i].idty;
								if(parentIdty === idt){ 
									pitem = this._by_idx[i].item;
									pIndex = i;
								}
								if(idty === idt){
									rowIndex = i;
									break;
								}
							}
							var mask = this.treeModel.cMask;
							var fChild = rowIndex - pIndex > 1;
							i = rowIndex+1;
							if(!fChild && i < this._by_idx.length && this.store.getValue(this._by_idx[i].item, 'p') == p)
								fChild = true;
							if(mask && !fChild){
								var c = this.store.getValue(pitem, 'c') || 0;
								if((c & mask) != 0)
									this.store.setValue(pitem, 'c', (c - mask));
								this.updateRow(pIndex); 
								
							}
							if(rowIndex >= 0){
								var items = this._treeCache.items, treePath = items[rowIndex] ? items[rowIndex].treePath : [], tp, count = 1;
								i = rowIndex + 1;
								for(; i < this._size; i++, count++){
									tp = items[i] ? items[i].treePath : [];
									if(items[i].treePath.length <= treePath.length){
										break;
									}
								}
								items.splice(rowIndex, count);
								this._onCleanupExpandoCache(idty);
								this._by_idx.splice(rowIndex, count);
								this._size -= count;
								this.updateRowCount(this._size);
								this._updateRenderedRows(rowIndex);
							}
						}
					});
					dojox.grid._Scroller.extend({
						measurePage: function(inPageIndex){
							if(this.grid.rowHeight){
								var height = this.grid.rowHeight + 1;
								return ((inPageIndex + 1) * this.rowsPerPage > this.rowCount ?
									this.rowCount - inPageIndex * this.rowsPerPage :
									this.rowsPerPage-1) * height;
									 
							}
							var n = this.getDefaultPageNode(inPageIndex);
							return (n && n.innerHTML) ? n.offsetHeight : undefined;
						}
					});

					appudo.FilteringSelect = declare(dijit.form.FilteringSelect);
					appudo.FilteringSelect.extend({
						maxHeight:300,
					    postCreate : function(args, frag) {	
					    	if(this.onInit)
					    		dojo.hitch(this, this.onInit)();
					    	this.inherited(arguments);
					    },
						onValue: function(v){},
						onChange: function(){
					    	this.inherited(arguments);
					    	if(this.state == '')
					    		this.onValue(this.displayedValue, this);
						},
						check: function() {
							if(this.state == '')
								return true;
							this._hasBeenBlurred = true;
							this.validate();
							this.focus();
							return false;								
						},
						getItemIdentity: function() {
							if(this.store)
								return this.store.getIdentity(this.item);
							return null;
						},
						getItemValue: function(n) {
							if(this.store)
								return this.store.getValue(this.item, n);
							return null;
						}
					});
					dijit.Menu.extend({
					    startup: function() {	
					    	this.inherited(arguments);
					    	if(this.ctx)
					    		this.ctx.init();
					    }
					});
					appudo.ItemFileWriteStore = FWS;					
					
					appudo.MainTab = declare(dijit.layout.TabContainer,
					{
						init : function() {   
							var list = this.tablist;
							var tab = this;
							appudo.on(list, 'addChild', list, function (page, index) {
								var c = this.getChildren();
								var button = index ? c[index] : c[c.length-1];
								var menu = button._closeMenu;
								dojo.connect(menu, '_openMyself', menu, function(e) { 
									var c = this.getChildren();
									var others = c[2];
									appudo.showMenuItem(others, list.getChildren().length == 1);									
								});
								menu.addChild(new dijit.MenuItem({
									label: nls.closeAll,
									dir: button.dir,
									lang: button.lang,
									textDir: button.textDir,
									onClick: dojo.hitch(tab, 'closeAll')
								}));
								menu.addChild(new dijit.MenuItem({
									label: nls.closeOther,
									dir: button.dir,
									lang: button.lang,
									textDir: button.textDir,
                                                                        onShow:function() {alert('onShow')},
									onClick: dojo.hitch(tab, 'closeOthers', page)
								}));
							});
						},
						canSave : function() { 
							var item = this.selectedChildWidget;
							if(item && item.changed)
								return item.changed();
							return false;
						},						
						save : function() { 
							var item = this.selectedChildWidget;
							if(item && item.save)
								item.save.call(item);
						},
						saveAll : function() { 
							var c = this.getChildren();
							var _this = this;
							dojo.forEach(c, function(item) {
								if(item.save)
									item.save.call(item);
							});
						},
						closeAll : function() { 
							var c = this.getChildren();
							var _this = this;
							dojo.forEach(c, function(item) {
								_this.removeChild(item);
							});
						},
						closeOthers : function(page) { 
							var c = this.getChildren();
							var _this = this;
							dojo.forEach(c, function(item) {
								if(item != page)
									_this.removeChild(item);
							});
						}
					});
					
					appudo.BottomTab = declare(dijit.layout.TabContainer,
					{
						constructor : function() {
							arguments[0].baseClass='bottomTab dijitTabContainer';
							arguments[0].tabPosition=arguments[0].region='bottom';
							arguments[0].splitter=true;
							arguments[0].showLabel=false;
							this._noMax = arguments[0].noMax;							
					    	this.inherited(arguments);
					    },
						selectChildAt : function(idx) {
							var c = this.getChildren();
							if(idx < c.length)
								this.selectChild(c[idx]);
						},
						postCreate : function() {   
							if(!this._noMax) 
								this.createMax();
							this.inherited(arguments);
			           },
					   createMax : function() { 
					    	var node = dojo.create('div', {class:'mBtn dijitToolbar'}, this.tablist.tablistWrapper, 'last'); 
							this.downButton = new appudo.IconButton(
							{
							    style:'margin:-3px 0px 0px 0px',
							    iconClass:'iMin',
								title:nls.min
							},
							dojo.create('div', null, node));
							this.upButton = new appudo.IconButton(
							{
							    style:'margin:-3px 0px 0px 0px',
							    iconClass:'iMax',
							    title:nls.max
							},
							dojo.create('div', null, node));
					   }
					});
					dijit.form.ValidationTextBox.extend({
						invalidMessage: nls.invalid,
						missingMessage: nls.required
					});
					appudo.Select = declare(dijit.form.Select,
					{
				        style: { width: '20em', margin:'0.5em 0 0.2em 0' }
					});
					appudo.ValidationTextBox = declare(dijit.form.ValidationTextBox,
					{
				        style: { width: '20em',margin:'0.5em 0 0.2em 0','padding-top':'0.2em' }
					});
					appudo.TextBox = declare(dijit.form.TextBox,
					{
				        style: { width: '20em',margin:'0.5em 0 0.2em 0','padding-top':'0.2em' }
					});
					appudo.TextArea = declare(dijit.form.SimpleTextarea,
					{ 
						style: { width: '20em',margin:'0.5em 0 0.2em 0','padding-top':'0.2em'},
						constructor : function() {
							if(!arguments[0].rows)
								arguments[0].rows=4;
					    	this.inherited(arguments);
					    }
					});
					appudo.ValidationTextArea = declare([dijit.form.ValidationTextBox,dijit.form.SimpleTextarea],
					{ 
						style: { width: '20em',margin:'0.5em 0 0.2em 0','padding-top':'0.2em'},
						rows:5,
						required:true,
  						isValid: function() {
  							this.inherited(arguments);
  							return this.containerNode.value.length > 0;
  						}
					});
					appudo.TemplateContent = declare(dijit.layout.BorderContainer, 
					{
						_stringRepl:dijit._TemplatedMixin.prototype._stringRepl
					});
					appudo.AddDropDown = declare(dijit.form.DropDownButton,
					{
						iconClass:'iAdd',
						constructor : function() {
							arguments[0].showLabel=false;
					    	this.inherited(arguments);
					    },
					    setIconClass: function(cls) {	
					        if(this.iconClass) 
					            dojo.removeClass(this.iconNode, this.iconClass);	
	
					        if(cls) {
					        	this.iconClass = cls;	
					            dojo.addClass(this.iconNode, cls);	
					        }
				    	}
					});
					var btn = {
							fixBtns : function () {
								if(this._bFixed)
									return;
								this._bFixed = true;
								var n = this.containerNode;
								if(!n)
									return;
								var btns = dojo.query('.dijitButtonNode .dijitInline', n);
								var m = 50;
								btns.forEach(function(it) {
									var mb = dojo.marginBox(it);
									if(mb) {
										var x = mb.w;
										m = x > m ? x : m;
									}
								}); 
								btns.forEach(function(it) {
						    		dojo.style(it, 'width', m+'px');
								}); 
							}
					};
					var frm = {
						_changed:true,
						_submitted:false,	
						_initValue:false,	
						buildRendering: function(){
							var labels = dojo.query('label', this.srcNodeRef);
							var options = dojo.query('option', this.srcNodeRef);
							var _this = this;
							options.forEach(function(item) { 
								item.innerHTML = _this._stringRepl(item.innerHTML);
							});
							labels.forEach(function(item) { 
								item.innerHTML = _this._stringRepl(item.innerHTML);
							});
					    	this.inherited(arguments);
						},
						reset : function() {
				    		this.inherited(arguments); 
							if(this._changed)
								this.onChildChange();
							this._changed = false;	
						},
						_setValueAttr : function() {
							this._initValue = true;
							this._changed = false;
				    		this.inherited(arguments); 	
						},
						onChildChange : function() {},
						_set : function(v) {
				    		this.inherited(arguments);
				    		if(v == 'value')
				    			this._childChange();
						},
						_childChange : function() {	  
				    		if(this._initValue) {
				    			this._initValue = false;
				    			return;
				    		}
				    		var c = this._changed;
							this._changed = true;	
							if(!c)
								this.onChildChange();
						},
					    onSubmit : function(event) {
					    	if(event)
					    		event.preventDefault();
				    		if(!this.validate() || this._submitted)
				    			return;
				    		this._submitted = true;
				    		this._changed = false;
				    	},	    	
				    };
					appudo.Form = declare(dijit.form.Form);
					appudo.Form.extend(frm);	
					appudo.UploadBox = declare(dijit.form.TextBox,
					{
						onInput: function(){return false;}
					});
					appudo.IconButton = declare(dijit.form.Button,
					{
						constructor : function() {
							arguments[0].showLabel=false;
					    	this.inherited(arguments);
					    },
						startup : function() {
					    	this.inherited(arguments);
					    	if(this.disableItem)
					    		appudo.addDisable(this.disableItem, this);
					    }	
					});		
					var cont = {
						liveSplitters:false,
						gutters:false,
					};
					var lazy = {
						stopParser:true,
						_noScript:true,
						_parsed:false,
						parseOnLoad:false,
						buildRendering : function() {
                                                    this.inherited(arguments);
                                                    this.node = dojo.place('<div class="Over" style="padding:6px;"><span class="dijitContentPaneLoading"><span class="dijitIconLoading dijitInline lIcon"></span>'+nls.load+'</span></div>', this.domNode, 'first');
                                                    this.__startup = this.startup;
                                                    this.__layout = this.layout;
                                                    this.layout = this.startup = function(){ };
                                                    this.lazyInit();
						},
                                                lazyInit : function() {
                                                },
						onHide : function() {
							if(!this.node)
								this.node = dojo.place('<div class="Over" style="padding:6px;"><span class="dijitContentPaneLoading"><span class="dijitIconLoading dijitInline lIcon"></span>'+nls.load+'</span></div>', this.domNode, 'first');
						},
						onShow : function() {
							var _this = this;
							if(!this._parsed) {
								this._parsed = true;
								this._started = false;
								var parent = this.domNode;
								dojo.parser.parse(parent, { noStart:true })//.then(function(){
									_this.startup = _this.__startup;
									_this.layout = _this.__layout;
									_this.startup();
									setTimeout(function() {
										if(_this.node) {
											dojo.destroy(_this.node);
										}
									}, 0); 
								//});
							}
						}
					};

					appudo.MenuBar = declare(dijit.MenuBar,
					{
						_mItem:null,
						onItemHover: function(item){
							if(this._mItem && this._mItem != item)
								this._mItem._setSelected(false);
							this.inherited(arguments);
						},
						onItemUnhover: function(item){
							this._mItem = item;
					    	this.inherited(arguments);
						}

					});
					
					appudo.IconBarItem = declare(dijit.MenuBarItem,
					{
						iconNode:null,
						constructor : function() {
					    	this.inherited(arguments);
							this.iconClass = arguments[0].iconClass;
					    },
						postCreate : function() {
					    	this.inherited(arguments);					    	
					    	if(this.iconClass)
					    		this.setICls(this.iconClass);
				    		dojo.addClass(this.containerNode, 'dijitInline');	
						},
					    setICls : function(cls) {	
					    	if(!this.iconNode) {  
					    		this.iconNode = dojo.create('span', {
					    			class:'dijitInline',
					    			style:'margin-right: 4px'
					    	    }, this.containerNode, 'before');
					    	}
							if(this.iconClass)
					    		dojo.removeClass(this.iconNode, this.iconClass);	
				    		dojo.addClass(this.iconNode, cls);	  
					    	this.iconClass = cls; 	  	
					    }
					});
					appudo.Container = declare(dijit.layout.BorderContainer);	
					appudo.LazyCont = declare(dijit.layout.BorderContainer);
					appudo.LazyPane = declare(dijit.layout.ContentPane);
					appudo.Container.extend(cont);
					appudo.LazyCont.extend(cont);
					appudo.LazyCont.extend(lazy);
					appudo.LazyPane.extend(lazy);
					appudo.TTDlg = declare(dijit.TooltipDialog, {
						onShow : function(args) {
					    	this.inherited(arguments);
					    	this.fixBtns();
							var mb = dojo.marginBox(this.domNode);
							if(mb && mb.w < 240)
								dojo.style(this.domNode, 'width', 240+'px');
						}
					});
					appudo.TTDlg.extend(btn);
					appudo.Dialog = declare(dijit.Dialog,
					{
						ctx:{},
						iconCls:null,
						_hidden:false,
						postCreate : function() {
					    	if(this.nonModal)
						    	this.class = 'nonModal';
					    	this.inherited(arguments);
					    	this.autofocus = this.ctx.autofocus!==undefined ? this.ctx.autofocus : true;
					    	if(this.ctx.title)
				    			this.setTitle(this.ctx.title);
					    	if(this.ctx.icls)
				    			this.setICls(this.ctx.icls); 

				    	},
					    setTitle : function(t) { 
				    		this.set('title', t);
					    },
					    setICls : function(cls) {
					    	var title = this.titleNode;
							if(this.iconCls)
					    		dojo.removeClass(title, this.iconCls);
					    	if(!cls) {
					    		dojo.style(title, null);
						    } else {
					    		dojo.style(title, 'padding', '1px 0 0 20px');
								dojo.addClass(title, cls); 
								this.iconCls = cls;
							}
					    },
						show : function(args) {
							this._hidden = false;
					    	this.inherited(arguments);
							this.openArgs = args;
					    	appudo.modal = true;
					    	var s = this.ctx.onShow;
					    	if(s)
					    		s(this, args);
					    	if(this.fBtn)
					    		this.fixBtns();
					    },
						hide : function() {
							if(this._hidden)
								return;
							this._hidden = true;
					    	this.inherited(arguments);
					    	appudo.modal = false;
					    }
					});
					appudo.Dialog.extend(btn);
					appudo.dndTreeTarget = declare(dojo.dnd.Source, {
						sourceTree:null,
						accept:['treeNode'],
						constructor: function(node, params){					
					    	this.inherited(arguments);
					    	this.sourceTree = fileTree;
							this.isSource = false;
							dojo.removeClass(this.node, 'dojoDndSource');	
						},
						checkAcceptance: function(source, nodes){							
							return source.tree && source.tree == this.sourceTree;
						},
						copyTarget: function(source){							
							return true;
						}
					});
					appudo.dndSource = declare(dijit.tree.dndSource, {					
						inTarget: false,
						firstIndent: -1,
						containerStateSave: '',
						inDrop: false,
						allowCopy: false,
						constructor : function(tree, params) {
					    	this.inherited(arguments);
					    	this.dndDrop = this.onDndDrop;
					    	this.onDndDrop = this._onDndDrop;
					    },
					    canDrag: function(node){
					    	return node.indent > this.firstIndent;
					    },
						copyTarget: function(source){							
							return false;
						},
					    copyState : function(keyPressed, self) {
					    	var t = m = dojo.dnd.manager().target;
					    	if(t && t.copyTarget(this) === true)
					    		return true;
					    	return this.allowCopy ? this.inherited(arguments) : false;
			            },
						_onDragMouse: function(e){
							// summary:
							//		Helper method for processing onmousemove/onmouseover events while drag is in progress.
							//		Keeps track of current drop target.
							
							var m = dojo.dnd.manager(),
								oldTarget = this.targetAnchor,			// the TreeNode corresponding to TreeNode mouse was previously over
								newTarget = this.current,				// TreeNode corresponding to TreeNode mouse is currently over
								oldDropPosition = this.dropPosition;	// the previous drop position (over/before/after)

							if(this.fileDrop && e.type != 'dragover')
								return;
							// calculate if user is indicating to drop the dragged node before, after, or over
							// (i.e., to become a child of) the target node
							var newDropPosition = 'Over';	
							this.targetAnchor = newTarget;
							if(this.fileDrop && newTarget && !this.dragDisabled){
								this.fileAnchor = newTarget;
								m.canDrop(this.checkFileDropAcceptance(newTarget, m.source, newDropPosition.toLowerCase()));
								return;
							}
							if(this.dragDisabled || !m.source || !newTarget || newTarget.indent < -1 || !newTarget.tree.isDndSource(m.source.tree))
							{
								m.canDrop(false);
								return;
							} 
							
					    	var btwn = this.betweenThreshold;
					    	if(newTarget.tree != m.source.tree)
					    		btwn = 0;
							if(newTarget && btwn > 0){
								// If mouse is over a new TreeNode, then get new TreeNode's position and size
								if(!this.targetBox || oldTarget != newTarget){
									this.targetBox = dojo.position(newTarget.rowNode, true);
								}
								var sib = newTarget.getNextSibling();
								if((e.pageY - this.targetBox.y) <= btwn){
									newDropPosition = 'Before';
								} else
								if(!sib && (e.pageY - this.targetBox.y) >= (this.targetBox.h - btwn)){
									newDropPosition = 'After';
								}
							}
							
							var canDrop = false;
							if(newTarget != oldTarget || newDropPosition != oldDropPosition){
								// Check if it's ok to drop the dragged node on/before/after the target node.
								if(!newTarget){
									m.canDrop(false);
								}else if(newTarget == this.tree.rootNode && newDropPosition != 'Over'){
									// Can't drop before or after tree's root node; the dropped node would just disappear (at least visually)		
									m.canDrop(false);
								}else if(m.source == this && (newTarget.id in this.selection)){
									// Guard against dropping onto yourself (TODO: guard against dropping onto your descendant, #7140)
									m.canDrop(false);
								}else if(this.checkItemAcceptance(newTarget.rowNode, m.source, newDropPosition.toLowerCase())
										&& !this._isParentChildDrop(m.source, newTarget.rowNode)){
									if(newTarget.isExpandable && !newTarget.isExpanded)
										newTarget.expand();
									canDrop = true;
									m.canDrop(true);
								}else{
									m.canDrop(false);
								}
								newDropPosition = canDrop ? newDropPosition : 'Over';
								
								this.targetAnchor = newTarget;
								this.dropPosition = newDropPosition;
								
								if(oldTarget){
									this._removeItemClass(oldTarget.rowNode, oldDropPosition);
								}
								if(newTarget){
									this._addItemClass(newTarget.rowNode, newDropPosition);
								}
							}
						},
						
						onDndCancel: function(){
							this.containerStateSave = '';
							this.inDrop = false;
							this.isDragging = false;
					    	this.inherited(arguments);
						},
					
						onOutEvent: function(){
							if(this.inDrop)
								return;
					 		var m = dojo.dnd.manager();
							if(this.isDragging){
								m.canDrop(false);
							}
					    	this.inherited(arguments);
						},
						
						onDndSourceOver: function(source){
							if(this.isDragging || this.inDrop || source != this)
								return;
					    	this.inherited(arguments);
						},
						
						onMouseOut: function(e){
							if(this.inDrop)
								return;
					    	this.inherited(arguments);
						},
						
						onMouseMove: function(e){
							if(this.inDrop || (this.isDragging && this.targetState == 'Disabled')) {
								return; 
							}
							if(this.isDragging) {
								this._onDragMouse(e);
							} else {
								var nodes = this.getSelectedTreeNodes();
								//console.log(nodes);
								if(nodes && nodes.length != 0 &&
								   this.inTarget && this.mouseButton == 0 && 
								   this.isSource && this.canDrag(nodes[0]))
									this.inherited(arguments);
							}
						},

						onMouseDown: function(e){
							if(this.dragDisabled)
								return;
							if(this.inDrop)
								this.onDndCancel();
								
							this.inTarget = dojo.hasClass(e.target, 'dijitTreeRow') || 
											dojo.hasClass(e.target, 'dijitTreeLabel') || 
											dojo.hasClass(e.target, 'dijitTreeIcon') || 
											dojo.hasClass(e.target, 'dijitTreeContent');
					    	this.inherited(arguments);
						},

						onMouseUp: function(e){		
							if(this.isDragging)
								this.targetCoords = {x:e.pageX, y:e.pageY};	
							if(this.mouseDown){
								this.isDragging = false;
								this.inTarget = false;
								this.mouseDown = false;
							}
						},
						
						checkFileDropAcceptance : function(event, source, position) {
							var node = dijit.getEnclosingWidget(event.target);
							if(!node || this.tree != node.tree || !node.rowNode)
								return false;
							var model = node.tree.model; 
							var store = model.store;
							var type = store.getValue(node.item, 't');
							if(type == 1) 
									return false;
							return true;
						},
						
						checkItemAcceptance : function(target, source, position) {
							var node = dijit.getEnclosingWidget(target);
							var model = node.tree.model; 
							var store = model.store;
							var type = store.getValue(node.item, 't');
							var snode = source.getSelectedTreeNodes()[0];
							if(!snode)
								return;
							var smodel = snode.tree.model; 
							var sstore = smodel.store;
							var stype = sstore.getValue(snode.item, 't');
							if(position != 'over') {
								var ps = node.getPreviousSibling();	
								if(type != 1 && stype == 1) {	
									if(position == 'after')
										return false;
									else
									if(ps && store.getValue(ps.item, 't') != 1)
										return false; 
								} else
								if(type == 1 && stype == 0) {
									var ns = node.getNextSibling();	
									if((ps && store.getValue(ps.item, 't') == 1) || 
									   (ns && store.getValue(ns.item, 't') == 1))
										return false; 
								}
							}
							else
							if(position == 'over' && type == 1) 
									return false;
							return true;
						
						},

						acceptFileDrop : function(node, files) {
							var stree = this.tree; 
							var smodel = stree.model; 
							var store = smodel.store; 
							var id = smodel.getIdentity(node.item);
							var parent = stree.absName(node);
							var d1 = new defer();
							var d = d1;
							var i = 0;
							var data = {};
							upBar.update({progress: 0});
							function onFile(file, folder) {
								var j = i++;
								if(file){
									var name = file.name;
									d = d.then(function(){
										var num = data.num;
										var x = (100 / num) * j;
										var di = {n:node,id:id};
										var fd = new FormData();
										fd.append('parent', parent);
                                                                                fd.append('subDir', folder);
										fd.append('name', name);
										fd.append('file', file);
										var p = new defer();
								        var xhr = new XMLHttpRequest();
								        xhr.upload.addEventListener('progress', function(e) {
								        	if(e.lengthComputable) {
								        		var p = Math.round(x + (e.loaded * (100 / num) / (e.total)));
								        		upBar.update({progress: p});
								        	}
								        	else
								        	{
								        		upBar.update({indeterminate: true});					        		
								        	}
								        }, false);
								        xhr.addEventListener('load', function() {
											var response = dojo.fromJson(xhr.responseText);
											var ioArgs = xhr.ioArgs;
											if(response.r == 0)
											{
									        	p.resolve();
									        	function n(pn, nm, t) {
													var ins = {};
													ins.node = pn;
													ins.nodeId = smodel.getIdentity(pn.item);									
													ins.pInfo = {parent:pn.item};
													var m = smodel;
													var s = m ? m.store : fileTree.store;
													var i = {t:t, l:nm}
													return fileTree.ins(i, ins, true);
									        	}
									        	if(folder) {
									        		var f = folder.split('/');
									        		var i = f[0] == '' ? 1 : 0;
									        		var len = f[f.length-1] == '' ? f.length-1 : f.length;
									        		var df = new defer();
									        		df.resolve();
								        			di.id = id;
								        			di.n = node;
									        		for(; i < len; i++) {
										        		df = df.then(function() {
										        			var fd = new defer();
										        			var nm = f[i];
															smodel.getChildren(di.n.item, fd.callback, fd.errback);
															return fd.then(function(its){
																its = dojo.filter(its, function(item){ return store.getValue(item, 'l') == nm; });
										        				if(its.length == 0){			
										        					di.n = n(di.n, nm, 0);
										        					di.id = smodel.getIdentity(di.n.item);
										        				} else {
										        					di.n = stree.getNodesByItem(its[0])[0];
										        					di.id = smodel.getIdentity(di.n.item);
										        				}
										        			});
										        		});
									        		}
									        		df.then(function(){n(di.n, name, 1)});
									        	} else {
									        		n(di.n, name, 1);
									        	}
											}
											else
											{
									        	p.cancel();
												appudo.onError(response, {xhr:xhr});	
											}
								        }, false);
								        xhr.addEventListener('error', function() {
								        	p.cancel();
											appudo.onError(response, {xhr:xhr});	        	
								        }, false);
								        xhr.addEventListener('abort', function() {
								        	p.cancel();			        	
								        }, false);
                                                                        xhr.open('POST', '/edit/2/');
								        upBar.stop = function() {
								        	xhr.abort();
								        }
								        xhr.send(fd);
								        return p;
									});
								} else 
								if(folder) {
									
								}
							}

					        upBar.stop = function() {
					        	d1.cancel();
								fileTree.endUpload();
					        }
				        	fileTree.beginUpload();
							appudo.parseFileList(files, onFile).then(function() {
								d.then(function() {
									fileTree.endUpload();
								}, function() {
									fileTree.endUpload();
								});
								data.num = i;
								d1.resolve();
							});
						},
						
						acceptDrop : function(source, nodes, copy) {
							var _this = this;
							var target = this.targetAnchor;
							var stree = source.tree; 
							var ttree = this.tree;
							var i = this.dropPosition == 'Over' ? 1 : 0;		
							var prev;
							if(source != this){
								ttree.foreignDrop(source, target, stree.selTop(), i, copy);
								this.onDndCancel();
							}else{		
								if(i == 0) {
									if(this.dropPosition == 'Before') {
										prev = target.getPreviousSibling();
										if(!prev) {
											i = 1;
											prev = target.getParent();
										}
										target = prev;   
									}
								}						
								var s = stree.selStr(stree.selTop());
								appudo.blockItems(ttree);
                                                                var content = {c:3, s:s, t:ttree.getDropTarget(target), i:i, z:ttree._treeType};
                                                                if(copy)
                                                                    content['n']=1;
								dojo.xhrPost({
                                                                        url : '/edit/0',
									handleAs: 'json',  
									failOk:true,
                                                                        content:content,
									load : function(response, ioArgs) {
										if(response && response.r == 0) {
											_this.dndDrop(source, nodes, copy);
										} else {			
											appudo.onError(response, ioArgs);				
											_this.onDndCancel();
										}
										appudo.blockItems(ttree, false);
										return response;
									},
									error : function(response, ioArgs) {
										console.log('error');
										_this.onDndCancel();
										appudo.blockItems(ttree, false);
										appudo.onError(response, ioArgs)
										return response;
									}
								});
							}
						},
						onFileDndDrop: function(source, nodes, copy){
							
						},
						
						onDndDrop: function(source, nodes, copy){
							if(this.containerState == 'Over') {
								var tree = this.tree,
									model = tree.model,
									target = this.targetAnchor,
									requeryRoot = false;

								this.isDragging = false;
								var targetWidget = target;
								var newParentItem;
								var insertIndex = 0;
								newParentItem = (targetWidget && targetWidget.item) || tree.item;
								if(this.dropPosition == 'Before' || this.dropPosition == 'After'){
									newParentItem = (targetWidget.getParent() && targetWidget.getParent().item) || tree.item;
									insertIndex = targetWidget.getIndexInParent();
									if(this.dropPosition == 'After'){
										insertIndex = targetWidget.getIndexInParent() + 1;
									}
								}else{
									newParentItem = (targetWidget && targetWidget.item) || tree.item;
								}
								var newItemsParams;

								dojo.forEach(nodes, function(node, idx){
									var sourceItem = source.getItem(node.id);

									if(dojo.indexOf(sourceItem.type, 'treeNode') != -1){
										var childTreeNode = sourceItem.data,
											childItem = childTreeNode.item,
											oldParentItem = childTreeNode.getParent().item;
									}

									if(source == this){
										if(typeof insertIndex == 'number'){
											if(newParentItem == oldParentItem && childTreeNode.getIndexInParent() < insertIndex)
												insertIndex -= 1;
										}
										model.pasteItem(childItem, oldParentItem, newParentItem, copy, insertIndex);
									}else if(model.isItem(childItem)){
										model.pasteItem(childItem, oldParentItem, newParentItem, copy, insertIndex);
									}else{
										if(!newItemsParams){
											newItemsParams = this.itemCreator(nodes, target.rowNode, source);
										}
										model.newItem(newItemsParams[idx], newParentItem, insertIndex);
									}
								}, this);
								this.tree._expandNode(targetWidget);
							}
							this.onDndCancel();
						},
						dndDrop: function(source, nodes, copy) {
						},
						
						_onDndDrop: function(source, nodes, copy) {	
							if(this.inDrop) 
								return;
							this.inDrop = true;
							this.containerStateSave = this.containerState;
							if(!this.targetAnchor)
								this.onDndCancel();
							else
							if(this.fileDrop) {
								var node = dijit.getEnclosingWidget(this.targetAnchor.target);
								this.acceptFileDrop(node, this.files);
							}
							else
								this.acceptDrop(source, nodes, copy);
						},
						dropFile : function(files) {
							if(this.dragDisabled)
								return;
							var m = dojo.dnd.manager();
							this.files = files;
							this.fileDrop = true;
							this.targetAnchor = this.fileAnchor;
							if(m.canDropFlag)
								dojo.publish('/dnd/drop', null);
							this.targetAnchor = null;
							this.fileDrop = false;
						},
						startDragFile : function() {
							if(this.dragDisabled)
								return;
							var m = dojo.dnd.manager();
			        		var node = dojo.create('span', {innerHTML:'File Drop'});
							if(this.ev)
								dojo.forEach(this.ev, dojo.disconnect);
							this.ev = [];
							this.ev.push(dojo.connect(dojo.doc, 'dragover', this, 'onMouseMove'),
										 dojo.connect(dojo.doc, 'dragover', this, 'onMouseOver'));
							m.startDrag(this, [node], false, true);
							this.inDrop = false;
							this.mouseDown = true;
							this.isDragging = true;
							this.fileDrop = true;
						},	
						stopDragFile : function() {
							var m = dojo.dnd.manager();
							this.targetAnchor = null;
							this.onDndCancel();
							dojo.forEach(this.ev, dojo.disconnect);
							this.ev = null;
							this.fileDrop = false;
							m.stopDrag();
						}
					});
					dijit._TreeNode.extend({
						removeChild: function(/* treeNode */ node){
							this.inherited(arguments);
							var children = this.getChildren();
							if(children.length == 0) {
								this.tree._collapseNode(this);	
								this.isExpandable = false;
								this._setExpando();								
							}
						}
					});
					appudo.Tree = declare(dijit.Tree,
					{
						dndController:appudo.dndSource,
						openRoot:true,
						showRoot:false,
						firstIndent: -1,
						betweenThreshold:0,
						_treeType:0,
						_iconClasses:[],
						startup : function() {
					   		this.inherited(arguments);
						   	treeMenu.bindDomNode(this.domNode);
						},
					    _expandNode : function(node, recursive){
							if(node)
					    		return this.inherited(arguments);
					    },
						onLoad: function(){	
							this.dndController.firstIndent = this.firstIndent;
							if(this.blurNode) {
								appudo.on(dijit.getEnclosingWidget(this.blurNode.domNode.parentNode), 'blur', this, function(e) {
							    	if(!appudo.modal)
							    		this.clearSelection();
							    });
						    }
							if(this.firstIndent < 0)
								dojo.addClass(this.domNode, 'hideExpando');
							this.tree.rootNode.set('indent', this.showRoot ? this.firstIndent : this.firstIndent-1);	
							if(this.openRoot)
								this._expandNode(this._getRootOrFirstNode(), false);
						},
						resize: function(changeSize){
							if(changeSize)
								dojo.marginBox(this.domNode, changeSize);
							
							this._nodePixelIndent = dojo._getMarginSize(this.tree.indentDetector).w;

							if(this.tree.rootNode)
								this.tree.rootNode.set('indent', this.showRoot ? this.firstIndent : this.firstIndent-1);
						},
						rebuild : function() {
    						this.dndController.selectNone();
    						this.rootNode.destroyRecursive();
    						this.rootNode.state = 'UNCHECKED';
    						this.model.root.children = null;
    						this.postMixInProperties();
    						this._load();
						},
						clearSelection : function(dnd) {
							if(dnd)
								this.dndController.selection={};
							this.set('selectedItems', []); 
						},
						getSelection : function() {
							return this.selectedItems;	
						},
						insPnt : function() {
							var item = this.selectedItems[0];
							var node;
							var model = this.model;
							var store = model.store;
							var next;
							var result = {}
							if(!item) {
								node = this.rootNode;								
								if(model.getIdentity(node.item) != 0) 
									node = node.getChildren()[0];
							} else {
								node = this.getNodesByItem(item)[0];
                                                        }
							if(!node) {
								result.node = this.rootNode;
                                                                result.nodetId = 0;
								return result;
							} else {
								if(node != this.rootNode && store.getValue(node.item, 't') == 1)
									node = node.getParent();
							}
							result.node = node;
							result.nodeId = store.getIdentity(node.item);									
							result.pInfo = {parent:node.item};
							return result;
						},
				
						selTop : function() {	 
							var selection = [];
							var select = this.selectedItems;
							var _this = this;
							dojo.forEach(select, function(entry, i) {
								var item = _this.getNodesByItem(entry)[0]; 
								var selected;
								item = item.getParent();
								while(!(selected = !item || (select.indexOf(item.item) != -1)) && item != _this.rootNode) {
									item = item.getParent();
								}
								if(!selected || !item)
									selection.push(entry);
							});
							return selection;
						},
						
						getDropTarget : function(node) {
							return this.model.getIdentity(node.item);
						},
						
						ins : function(args, insPnt, no) {
							var model = this.model;
							var store = model.store;
							var pInfo = insPnt.pInfo;
							var node = insPnt.node;
							var pitem;
                                                        args.p = 0;
							if(pInfo) {
								pitem = pInfo.parent;								
								args.p = store.getIdentity(pitem);
								if(!pitem)
									pitem = model.root;
							}

                                                        var item = store.newItem(args, pInfo.root ? null : {parent: pitem, attribute: model.childrenAttrs[0]});
							store.save({onComplete: appudo.saveDone, onError: appudo.saveFailed});
							if(args.t == 1 || !model.mayHaveChildren(pitem)) {
                                                                model.pasteItem(item, pitem, pitem, false, 0);
							} else {				
								next = node.getChildren()[0];	
								while(next && store.getValue(next.item, 't') != 0)
									next = next.getNextSibling();
                                                                model.pasteItem(item, pitem, pitem, false, next ? next.getIndexInParent() : 0);
                                                        }
                                                        var n = this.getNodesByItem(item)[0];
                                                        if(!no && n)
							{
                                                            var _this = this;
                                                            setTimeout(function() {
                                                                    _this.set('path', n.getTreePath());
                                                            }, 200);
							}
							return n;
						},
						
						foreignDrop : function(source, target, nodes, into, copy) {
						},
												
						isDndSource : function(tree) {
							if(tree == this)
								return true;
							if(!this._dndSources)
								return false;
							return this._dndSources.indexOf(tree) != -1;
						},
						
						setCopy : function(b) {
							this.dndController.allowCopy = b;
						},

						add : function(type, name, data, ins, ndata) { 
							if(!ins)
								ins = this.insPnt();
							content = {c:2, z:this._treeType, t:type, p:ins.nodeId, l:name};
							this.addItem(2, dojo.mixin(content, data), dojo.mixin({t:type, l:name, children:[]}, ndata), ins);
						},

						askDelete : function(target) { 
							var _this = this;
							this.askDeleteItem(1, target, function(node){return _this.getNodesByItem(node)[0];}, {z:this._treeType});
						},

						askRename : function(item) {	
							var _this = this;
							var model = this.model;
							var store = model ? model.store : this.store;
							var node = this.getNodesByItem(item)[0];
							appudo.ask(nls.renDlg, node.iconNode, {before:appudo.askAddText(store.getValue(item, 'l')),onOk:function(d){
								appudo.blockItems(_this);
								dojo.xhrPost({
                                                                        url : '/edit/0',
									handleAs: 'json',
									failOk:true,
									content:{c:'M',n:_this.getDropTarget(node),l:d.value,z:_this._treeType},
									load : function(response, ioArgs) {
										if(response && response.r == 0) {
											store.setValue(item, 'l', d.value);
											dojo.forEach(mainTab.getChildren(), function(i) {
												if(i.ctx && i.ctx.openRef == item)
													i.set('title', d.value);
											});
										} else {
											_this._onError(null, response, ioArgs);
										}
										appudo.blockItems(_this, false);
										return response;
									},
									error : dojo.hitch(_this, _this._onError, null)
								});
							}}); 							
						},	
						
						lock : function() {
							var _this = this;
							var items = this.selectedItems;
							if(items.length != 0) {
								var item = items[0];
								var node = this.getNodesByItem(item)[0];
								appudo.ask(nls.slock,node.iconNode, {onOk:function(){
									appudo.blockItems(_this);
									var model = _this.model;
									var store = model.store;
									dojo.xhrPost({
                                                                                url : '/edit/0',
										handleAs: 'json',
										failOk:true,
										content:{c:0, n:_this.selStr(items), z:_this._treeType},
										load : function(response, ioArgs) {
											if(response && response.r == 0) {	
												var refs = [];
												var c = mainTab.getChildren();
												dojo.forEach(c, function(i, j) {
													if(i.ctx && i.ctx.openRef)
														refs[j] = i.ctx.openRef;
												});
												dojo.forEach(items, function(i) {
													var l = store.getValue(i, 'a'); 
													var k = dojo.indexOf(refs, i);
													store.setValue(i, 'a', !l);
													if(k != -1)
														c[k].set('iconClass', _this.getIconClass(i));
												});
											} else {
												_this._onError(null, response, ioArgs);
											}
											appudo.blockItems(_this, false);
											return response;
										},
										error : dojo.hitch(_this, _this._onError, null)
									});
								}});
							}
						},
						
						askAdd : function(target, txt, onOk, type) {
							var root = this.insPnt(0);
							if(root.node) {
								var node = root.node;
								if(node.indent >= 0)
									target = node.iconNode;
								dojo.window.scrollIntoView(node.iconNode);
								appudo.ask(txt, target, {root:root, onOk:onOk, before:appudo.askAddText()});
						    	
							}
				    	},
				    	
						askFolder : function(target, data) {
							var _this = this;
							this.askAdd(target, nls.folderDlg, function(v, d) {_this.add(0, v.value, data, d.root)});
				    	},
				    	
						askPage : function(target) {
							var _this = this;
							var data = {a:1};
							this.askAdd(target, nls.pageDlg, function(v, d) {_this.add(0, v.value, null, d.root, data)});
				    	},
				    	
						getIconClass : function(item, opened) {
							var ic = this._iconClasses;
							var model = this.model;
							var store = model.store;
							if(item.root)
								return '';
							return (model.getIdentity(item) == 0 && ic[0]) ? ic[0] : store.getValue(item, 't') == 0 ? ic[1] : ic[2];
						},
						mapType : function(type){
							return type;
						},
					  	onDblClick : function(item) {
					    	var model = this.model;
							var store = model.store;
							var type = store.getValue(item, 't');
							var l = store.getValue(item, 'l');
					    	appudo.openItem(item, model.getLabel(item), this.getIconClass(item), this.getPage({id:model.getIdentity(item), type:this.mapType(type), _l:l, _item:item}), this.getHook(type));
					    },
						setDnD : function(enable) {
							if(this.dndController)
								this.dndController.dragDisabled = !enable;
						}
                                        });
                                        appudo.openTab = function(url, label, iconCls) {
                                                var _this = this;
                                                var gp = function(parent, onErr) {return appudo.cache(url, undefined, onErr)};
                                                if(url == null) {
                                                    gp = function(parent, onErr) {
                                                        var d = new appudo.defer();
                                                        d.resolve('');
                                                        return d;
                                                    };
                                                }
                                                return appudo.openItem(url, label, iconCls, gp, null);
                                        }
					appudo.Tree.extend(ctrl);
					appudo.PageTree = declare(appudo.Tree,
					{ 
						_treeType:0,
						lockable:true,
						betweenThreshold:5,
						_itemPages:[tmpl.module, tmpl.module],
						startup : function() {
					    	this.inherited(arguments);
							var modHook = function() {return new dlist([appudo.modNls(), appudo.errNls()])};
							this._disableItems = pageBar._disableItems;
							this._itemHooks = [modHook, modHook];
							this.dndController.copyTarget = function(source){							
								return source == modTree.dndController;
							};
					    },
						getIconClass : function(item, opened) {
							var model = this.model;
							var store = model.store;
							if(item.root)
								return '';
							var a = store.getValue(item, 'a'); 
							var t = store.getValue(item, 't'); 
							return model.getIdentity(item) == 0 ? 'iRoot' : t == 0 ? a ? 'iPageL' : 'iPage' : a ? 'iModHalt' : 'iModRun';
						},					
						foreignDrop : function(source, target, nodes, into, copy) {
							var _this = this;
							var item = nodes[0];
							var stree = source.tree; 
							var smodel = stree.model;
							var sstore= smodel.store;
							var t = sstore.getValue(item, 't');
							var mid = sstore.getIdentity(item);
							var m = this.model;
							var s = m.store;
							if(nodes.length != 1 || t != 1)
								return;
							appudo.ask(nls.ninst, null, dojo.mixin({before:appudo.askAddText(), onOk:function(v, d){
								_this.add(1, v.value, {m:mid}, {pInfo:{parent:target.item},nodeId:s.getIdentity(target.item)}, {a:true});
							}}, this.dndController.targetCoords));
							
						}
					});
					appudo.ModuleTree = declare(appudo.Tree,
					{ 
						_treeType:3,
						_iconClasses:['iModRoot','iFolder','iMod'], 
						_itemPages:[null, null, tmpl.module],
						startup : function() {
					    	this.inherited(arguments);
							var modHook = function() {return new dlist([appudo.modNls(), appudo.errNls()])};
							this._itemHooks = [null, modHook];
							this._disableItems = dataBar._disableItems;
							pageTree._dndSources = [modTree];
					    },
					    onLoad : function(target, type) {
					    	this.inherited(arguments);
							this.dndController.firstIndent = 0;
						},
						mapType : function(type){
							if(type == 1)
								return 2;
							return type;
						}
					});
					appudo.UserTree = declare(appudo.Tree,
					{ 
						_treeType:2,
						lockable:true,
						_iconClasses:['iGroup','iGroup','iUser'], 
						_itemPages:[tmpl.group, tmpl.user],
						startup : function() {
					    	this.inherited(arguments);
							this.setCopy(true);
							this._disableItems = userBar._disableItems;
					    },
                                            getMenuId : function(id, type) {
                                                return type == 1 ? appudo.shift1032(id) : id;
                                            },
					    onLoad : function(target, type) {
					    	this.inherited(arguments);
							this.dndController.firstIndent = 0;
							var n = this.rootNode.getChildren()[0];
							dojo.addClass(n.rowNode, 'mRow');
                                            },
                                            askAddUser : function(target, type) {
                                                var _this = this;
                                                var item = this.selectedItems[0];
                                                var model = this.model;
                                                var store = model.store;
                                                var ins = this.insPnt();
                                                if(type == 0) {
                                                        var n = this.rootNode.getChildren()[0];
                                                        ins = {
                                                                        node:n,
                                                                        nodeId:'0',
                                                                        pInfo:{parent:n.item,root:true}
                                                                };
                                                }
                                                if(!item && type == 1)
                                                        return;
                                                appudo.ask(type == 0 ? nls.newGroup : nls.newUser, type == 0 ? target : ins.node.iconNode, {before:appudo.askAddText(), onOk:function(v) {
                                                        _this.add(type, v.value, {a:'t'}, ins);
                                                }});
                                            }
					});
					appudo.DataTree = declare(appudo.Tree,
					{ 
                                            _treeType:4,
                                            lockable:true,
                                            _iconClasses:['iTbl','iTbl','iRow'],
                                            _itemPages:[tmpl.tbl, tmpl.row],
                                            startup : function() {
                                            this.inherited(arguments);
                                                    this.setCopy(true);
                                                    this._disableItems = dataBar._disableItems;
					    },
					    onLoad : function(target, type) {
					    	this.inherited(arguments);
							this.dndController.firstIndent = 0;
							this.dndController.canDrag = function(node) {return node.indent == 0;}
							var n = this.rootNode.getChildren()[0];
							dojo.addClass(n.rowNode, 'mRow');
                                            },
                                            itemToObj: function(item) {
                                                    var sn = {};
                                                    var model = this.model;
                                                    var s = model.store;
                                                    dojo.forEach(s.getAttributes(item), function(attr) {
                                                            sn[attr] = s.getValue(item, attr);
                                                    });
                                                    return sn;
                                            },
                                            askAddTable : function(target, type) {
                                                    var _this = this;
                                                    var item = this.selectedItems[0];
                                                    var model = this.model;
                                                    var store = model.store;
                                                    var ins = this.insPnt();
                                                    if(type == 0) {
                                                            var n = this.rootNode.getChildren()[0];
                                                            ins = {
                                                                            node:n,
                                                                            nodeId:'0',
                                                                            pInfo:{parent:n.item,root:true}
                                                                    };
                                                    }
                                                    if(!item && type == 1)
                                                            return;
                                                    appudo.ask(type == 0 ? nls.newTable : nls.newCol, type == 0 ? target : ins.node.iconNode, {before:appudo.askAddText(), onOk:function(v) {
                                                            _this.add(type, v.value, {a:'t'}, ins);
                                                    }});
                                            }
					});
					appudo.FileTree = declare(appudo.Tree,
					{
						_treeType:1,
						_numUploads:0,
						_itemPages:[tmpl.folder, tmpl.editor],
						startup : function() {
					    	this.inherited(arguments);
							this._disableItems = fileBar._disableItems;
							var editHook = function() {return appudo.editNls()};
							this._itemHooks = [null, editHook];
					    	appudo.addDisable(this, this);
					    },
						getPage : function(data) {
							var _this = this;
							var item = data._item;
							var node = this.getNodesByItem(item)[0];
							data.mode = appudo.fileType(data._l);
                                                        return function(parent, onErr) {dojo.mixin(parent.ctx, data);parent.ctx.absName=_this.absName(node);return appudo.cache(_this._itemPages[data.type], undefined, onErr)};
						},
						itemToObj: function(item) {
							var sn = {};
							var model = this.model;
							var s = model.store;
							dojo.forEach(s.getAttributes(item), function(attr) {
								sn[attr] = s.getValue(item, attr);
							});
							return sn;
						},
						getDropTarget : function(node) {
							return this.absName(node);
						},
					  	beginUpload : function() {
                                                        var item = dojo.query('.fProg', fileBar.domNode)[0];
                                                        appudo.show(item, 'block');
			  				var p = dijit.getEnclosingWidget(item);
			  				this.setDnD(false);
				        	appudo.blockItems(p);
					    },
					  	endUpload : function() {
                                                        var item = dojo.query('.fProg', fileBar.domNode)[0];
                                                        appudo.hide(item);
			  				var p = dijit.getEnclosingWidget(item);
                                                        appudo.blockItems(p, false);
			  				this.setDnD(true);
					    	
					    },	
					    getIconClass : function(item, opened) {
							var model = this.model;
							var store = model.store;
							if(item.root)
								return '';		
							var l = store.getValue(item, 'l');
							var t = store.getValue(item, 't');
							var file;
							if(t != 0)
								file = appudo.fileIcon(l);
							return model.getIdentity(item) == 0 ? 'iFileRoot' : t == 0 ? 'iFolder' : file;
						},
					    absName : function(node) {
							var root = this.rootNode.getChildren()[0];
							var model = this.model;
					    	var s = model.store;
					    	var r = ''; 
					    	var a = ''; 
					    	if(node == root)
					    		return r;
					    	do {
						    	r = s.getValue(node.item, 'l') + a;
						    	a = '/' + r;
						    }
						    while((node = node.getParent()) != null && node.item && (node != root));
				    		return r;
					    },
						rootName : function() {
							var node = this.rootNode.getChildren()[0];
							var model = this.model;
					    	var s = model.store;					    	
							return '/' + s.getValue(node.item, 'l');
						},
						add : function(type, name, data, ins, ndata) { 
							var _this = this;
							if(!ins)
								ins = this.insPnt();
							content = {c:2, z:this._treeType, t:type, p:_this.absName(ins.node), l:name};
							this.addItem(2, dojo.mixin(content, data), dojo.mixin({t:type, l:name}, ndata), ins);
						},
						selStr : function(selection) {
							var _this = this;
                                                        var nodes = [];
							var model = this.model;
							var store = model ? model.store : this.store; 
							var node;

							dojo.forEach(selection, function(entry, i) {
								node = _this.getNodesByItem(entry)[0];
                                                                //nodes[model.getIdentity(entry)] = _this.absName(node);
                                                                nodes.push(_this.absName(node))
                                                        });
                                                        return dojo.toJson(nodes);
						},	
					});
				},
				
				initCtx : function(widget, ctx) {
					if(!ctx)
						ctx = {};
					switch(widget) {
					case 'mainbar':
						ctx.save = function() {mainTab.save()};
						ctx.saveAll = function() {mainTab.saveAll()};
						ctx.closeAll = function() {mainTab.closeAll()};
                                                ctx.undo = function() {alert('undo')};
                                                ctx.redo = function() {alert('redo')};
						ctx.search = function() {searchDlg.show();};
                                                ctx.oview = function() {alert('oview')};
                                                ctx.pack = function() {
                                                    var form = document.createElement('form');
                                                    form.setAttribute('method', 'post');
                                                    form.setAttribute('action', '/edit/3');
                                                    form.setAttribute('target', '_blank');

                                                    var i = document.createElement('input');
                                                    i.setAttribute('type', 'text');
                                                    i.setAttribute('name', 'c');
                                                    i.setAttribute('value', '0');
                                                    form.appendChild(i);

                                                    i = document.createElement('input');
                                                    i.setAttribute('type', 'text');
                                                    i.setAttribute('name', 'z');
                                                    i.setAttribute('value', '@');
                                                    form.appendChild(i);

                                                    i = document.createElement('input');
                                                    i.setAttribute('type', 'text');
                                                    i.setAttribute('name', 'p');
                                                    i.setAttribute('value', appudo.aid);
                                                    form.appendChild(i);

                                                    i = document.createElement('input');
                                                    i.setAttribute('type', 'text');
                                                    i.setAttribute('name', 'n');
                                                    i.setAttribute('value', '1');
                                                    form.appendChild(i);

                                                    document.body.appendChild(form);
                                                    form.submit();
                                                    document.body.removeChild(form);
                                                };
                                                ctx.clear = function() {alert('clear')};
                                                ctx.props = function() {alert('props')};
                                                ctx.wcm = function() { appudo.openTab(tmpl.welcome, nls.welcome, 'iW'); };
                                                ctx.about = function() { appudo.openTab(tmpl.about, nls.about, 'iW'); };
						ctx.logout = function() {appudo.logout();};
						break;
					case 'gridMenu':
						ctx.init = function() {
							dojo.connect(gridMenu, '_openMyself', gridMenu, function(e) {
				  				var grid = this.grid;
				  				var item = this.data;
								this.data = null;
								this.lastData = item;
								if(item) {
					  				var model = grid.treeModel;
					  				appudo.showMenuItem(gridMenu.into, !model || model.store.getValue(item, 'p') !== undefined);
				  				} else {
									dijit.popup.close(this);
				  				}
						 	});
							appudo.on(gridMenu, 'close', gridMenu, function() {
								this.isOpen = false;
						 	});
						};
                                                ctx.open = function() {alert('open')};
						ctx.into = function() {gridMenu.grid.goInto(gridMenu.lastData)};
						ctx.del = function() {gridMenu.grid.askDelete()};
						break;
					case 'treeMenu':
						ctx.init = function() {
							var c = treeMenu.getChildren();
							var first = c[0];
							var sep = c[1];
							var i = dojo.query('.dijitMenuItemIconCell', first.domNode)[0];
							i.innerHTML = '<span style="margin-left:2px">'+nls.id+'</span>';
	                                               	dojo.connect(treeMenu, '_openMyself', treeMenu, function(e) {
				  				var tn = dijit.getEnclosingWidget(e.target);
								if(typeof tn.item != 'undefined') {
									var sId = tn.tree == modTree;
					  				appudo.showMenuItem(first, sId);
					  				appudo.showMenuItem(sep, sId);
					  				appudo.showMenuItem(this.lock, !tn.tree.lockable);
                                                                        var model = tn.tree.model;
                                                                        first.set('label', tn.tree.getMenuId ? tn.tree.getMenuId(model.getIdentity(tn.item), model.store.getValue(tn.item, 't')) : model.getIdentity(tn.item));
                                                                        tn.tree.dndController.setSelection([tn]);
									this.data = tn;
								} else {
									dijit.popup.close(this);
								}										
						 	}); 
						};
						ctx.open = function() {
							var data = treeMenu.data;
							var item = data.item;
					    	var tree = data.tree;
					    	var model = tree.model;				    	
							var store = model.store;
							var type = store.getValue(item, 't');
							var l = store.getValue(item, 'l');
					    	appudo.openItem(item, model.getLabel(item), tree.getIconClass(item), tree.getPage({id:model.getIdentity(item), type:type, _l:l}), tree.getHook(type));
						};
						ctx.rename = function() {
							var data = treeMenu.data; 
					    	var tree = data.tree;
					    	tree.askRename(data.item);
						};
						ctx.lock = function(){ 
							var data = treeMenu.data; 
							data.tree.lock()
						};
						ctx.del = function(){ 
							var data = treeMenu.data; 
							data.tree.askDelete(); 
						};
						break;
					case 'pageBar':		
						ctx.p = ctx.m = true;			
						ctx.pchg = function(c){ctx.p = c;ctx.chg()};
						ctx.mchg = function(c){ctx.m = c;ctx.chg()};
						ctx.chg = function(){
							var m = pageTree.model;
							if(ctx.m && ctx.p){
                                                                m.query = {id:'0'};
								m.cquery = null;
								pageTree.setDnD(true);	
							}else
							if(!ctx.p && ctx.m){
								m.cquery = null;
								m.query = {t:1};
							}else
							if(!ctx.m && ctx.p){
                                                                m.query = {id:'0'};
								m.cquery = {t:0};	
								pageTree.setDnD(false);					
							}
							else{
								m.query = {t:10};
								m.cquery = null;
							}
							pageTree.rebuild();
						};
						ctx.lock = function(){pageTree.lock()};
						ctx.del = function() {pageTree.askDelete()};
						ctx.addP = function(e) {pageTree.askPage(e.target)};
						ctx.addM = function(e) {appudo.ask(nls.modIDlg, e.target, {nobtn:true})};
						break;
					case 'fileBar':
						ctx.addD = function(e) {fileTree.askFolder(e.target)};
						ctx.addF = function(e) {fileTree.askAdd(e.target, nls.fileDlg, function(v, data) {fileTree.add(1, v.value, data, data.root)})};
						ctx.del = function() {fileTree.askDelete()};
						ctx.upF = function(e) {fileTree.askUpload(e.target)};
						ctx.stop = function() {upBar.stop()};
						break;
					case 'userBar':
						ctx.addG = function(e) {userTree.askAddUser(e.target,0)};
						ctx.addU = function(e) {userTree.askAddUser(e.target,1)};
						ctx.lock = function() {userTree.lock()};
						ctx.del = function() {userTree.askDelete()};
						break;
					case 'modBar':
						ctx.addM = function(e) {modTree.askAdd(e.target, nls.modDlg, function(v, d) {modTree.add(1, v.value, null, d.root)})}						
						ctx.addD = function(e) {modTree.askFolder(e.target,{e:''})};
						ctx.del = function() {modTree.askDelete()};
						break;
					case 'dataBar':
                                                ctx.addC = function(e) {dataTree.askAddTable(e.target,1)}
                                                ctx.addT = function(e) {dataTree.askAddTable(e.target,0)};
						ctx.del = function() {dataTree.askDelete()};
						break;
					case 'askDlg':
						ctx.blur = function(){if(!ctx.preventClose) dijit.popup.close(askDlg); ctx.preventClose = false};
						break;
					}
					return ctx;
				},
				
				openItem : function(ref, title,iconClass, contentFunc, hook) {
					var open = null;
					dojo.forEach(mainTab.getChildren(), function(i) {
						if(i.ctx && i.ctx.openRef == ref)
							open = i;
					});

					if(open) {
						mainTab.selectChild(open);
                                                return open;
                                        } else{
                                            var _ctx = {}
                                            var remove = function(item) {
                                                mainTab.removeChild(item);
                                            }
                                            var reload = function() {
                                                var ctx = dojo.mixin({openRef:ref}, _ctx);
                                                var p = new dijit.layout.ContentPane({ title:title, style:'padding:0px', ctx:ctx, closable:true, iconClass:iconClass });
						mainTab.addChild(p);		
                                                mainTab.selectChild(p);
                                                ctx._selfPane = p;
                                                var defer = contentFunc(p, function() {
                                                    d = 'error';
                                                    if(hook)
                                                            hook().then(function(){p.set('content', d)});
                                                    else
                                                            p.set('content', d);
                                                });
						setTimeout(function() {
							defer.then(function(d) {
								if(hook)
									hook().then(function(){p.set('content', d)});
								else
									p.set('content', d);
							});
                                                }, 0);
                                                return p;
                                            }
                                            _ctx.remove = remove;
                                            _ctx.reload = reload;
                                            return reload();
					}
				},
				
				ask : function(text, target, data) {
					dojo.style(askDlg.domNode, 'width', null);
					var form = dijit.byNode(dojo.query('form', askDlg.domNode)[0]);
					var btn = dojo.query('.dBtn', askDlg.domNode)[0];
                                        if(data.nobtn)
                                                appudo.hide(btn);
					else
                                                appudo.show(btn, 'block');
					var cnt = dojo.query('.dCnt', askDlg.domNode)[0];
					if(cnt.innerHTML != '') {
						dojo.forEach(dijit.findWidgets(cnt), function(w) {
						    w.destroyRecursive();
						}); 
						cnt.innerHTML = '';
					}
					if(data.before)
						data.before(cnt, data);			
					function sub(e) {
						if(e)
							e.preventDefault(); 
						if(data.onOk)
						{           
							if(!form.validate()) 
								return;	
				        	if(data.onOk)
				        		data.onOk(form.get('value'), data);
				        }
						dijit.popup.close(askDlg); 
					}
					var submit = appudo.on(form, 'submit', this, function(e) {
						sub(e);
			        }); 
					dojo.query('.dLabel', askDlg.domNode)[0].innerHTML = text;
					appudo.modal = true;
					var d = {popup:askDlg, onClose:function(event) {
			        	appudo.modal = false;
						submit.remove();
						dijit.focus(target); }};
					if(target) {
						d.around = target;
					} else 
					if(data.x !== undefined && data.y !== undefined) {
						d.x = data.x
						d.y = data.y
					}
			        dijit.popup.open(d);
			       	askDlg.focus();	
			       	return sub;
				},
				
				askAddText : function(txt, nreq, reg, emsg){ 
					return function(cnt, data) {
		        		var node = dojo.create('div', null, cnt);   
		        		var d = {
						    type:'text', 
						    name:'value', 
						    style:'width:100%',
						    value:txt,
						    required: !nreq,
						};
						if(reg)
						   d.regExp = reg;
						if(emsg)
						   d.invalidMessage = emsg;
			        	new dijit.form.ValidationTextBox(d, node);
		        	};
		        }, 	
				
				askAddSelect : function(store, value){ 
					return function(cnt, data) {
		        		var node = dojo.create('div', null, cnt);    
		        		
		        		store.query(function(o){
		                    var c = dojo.create('option');
		                    c.innerHTML = o.n;		                    
		                    c.value = o.v;
		                    if(value == o.v)
		                    	dojo.setAttr(c, 'selected', 'selected');
		                    node.appendChild(c);
		        	    });
		        		
			        	new appudo.Select(
						  {
						    type:'text', 
						    name:'value',  
						    store: store
						  },
						node);
		        	};
		        }, 	
				
				askAddMSelect : function(store, dbl){ 
					return function(cnt, data) {
		        		var node = dojo.create('div', null, cnt);  
		        		
		        		store.query(function(o){
		                    var c = dojo.create('option');
		                    c.innerHTML = o.n;		                    
		                    c.value = o.v;
		                    node.appendChild(c);
		        	    });
			        	new dijit.form.MultiSelect(
						  {
						    type:'text', 
						    name:'value', 
						    style:'width:100%',    
						    store: store,
						    onDblClick:function(e){
						    	var v = this.get('value');
						    	if(v && v.length != 0 && dbl !== undefined)
						    		dbl(e);
						    }
						  },
						node);
		        	};
		        }, 	
		        
				askAddCheck : function(value, nreq){ 
					return function(cnt, data) {
		        		var node = dojo.create('div', {innerHTML:'<label>'+(value?nls.uncheck:nls.check)+'</label>'}, cnt);    
		        		node = dojo.create('div', null, node);  
			        	new dijit.form.CheckBox(
						  {
						    name:'value',
						    checked:!value,
						    style:'display:none'
						  },
						node);
		        	};
		        }, 	
		        
		        askAddUpload : function(item, parent, ins){ 
					return function(cnt, data) {
						var fn = dojo.query('form', askDlg.domNode)[0];
						var form = dijit.byNode(fn);
						var div = dojo.create('div', {class:'Btn', style:'width:100%'}, cnt);   
						var node = dojo.create('div', null, div);   
			        	new dijit.form.Button({
						    label:nls.sel, 
						    name:'value',
						    style:'float:left;'
						}, node);
						node = dojo.create('div', null, div);   
			        	var txt = new appudo.UploadBox({
						    type:'text', 
						    name:'value', 
						    style:'float:left;margin-top:2px;padding:2px 0 1px 0;'
						}, node);
		        		var input = dojo.create('div', { style:{width:'100%'}, innerHTML: '<input class="file" style="opacity:0;-moz-opacity:0;filter:alpha(opacity=0);height:30px;position:absolute;left:15px;right:10px;top:48px" name="file"  onClick="askDlg.ctx.preventClose = true" type="file">' }, div); 
						div = dojo.create('div', {style:{height:'0px',clear:'both'}}, div);   
		        		form.reset();
		        		form.set('method', 'POST');
                                                form.set('action', '/edit/2/');
						form.set('enctype', 'multipart/form-data');						

						var inp = dojo.query('.file', askDlg.domNode)[0];
						var fd = new FormData();
						var name;
						var change = appudo.on(inp, 'change', function(event) {
							var files = event.target.files;
							name = files[0].name;
							fd.append('parent', parent);
                                                        fd.append('subDir', "");
							fd.append('name', name);
							fd.append('file', files[0]);
							txt.set('value', name);
						});
				        data.onOk = function() {
					        var xhr = new XMLHttpRequest();
							upBar.update({progress: 0});
					        xhr.upload.addEventListener('progress', function(e) {
					        	if(e.lengthComputable) {
					        		var p = Math.round(e.loaded * 100 / e.total);
					        		upBar.update({progress: p});
					        	}
					        	else
					        	{
					        		upBar.update({indeterminate: true});					        		
					        	}
					        }, false);
					        xhr.addEventListener('load', function() {
								item.endUpload();
								var response = dojo.fromJson(xhr.responseText);
								var ioArgs = xhr.ioArgs;
								if(response.r == 0)
								{
									var m = fileTree.model;
									var s = m ? m.store : fileTree.store;
									var i = {t:1, l:name}
									var n = fileTree.ins(i, ins);
								}
								else
									appudo.onError(response, ioArgs);	
					        }, false);
					        xhr.addEventListener('error', function() {
								item.endUpload();			
								var response = dojo.fromJson(xhr.responseText);
								var ioArgs = xhr.ioArgs;
								appudo.onError(response, ioArgs);	        	
					        }, false);
					        xhr.addEventListener('abort', function() {
								item.endUpload();					        	
					        }, false);
                                                xhr.open('POST', '/edit/2/');
					        upBar.stop = function() {
					        	xhr.abort();
					        }
				        	item.beginUpload();
					        xhr.send(fd);
				        }

		        	};
		        }, 		
		        	        
				saveDone : function() {
				},
				
				saveFailed : function() {
				},
				
				addDisable : function(widget, item) {
					if(!widget._disableItems)
						widget._disableItems = [];
					widget._disableItems.push(item);
				},
				
				blockItems : function(widget, block) {
					if(!widget || !widget._disableItems)
						return;
					if(block === undefined)
						block = true;

					dojo.forEach(widget._disableItems, function(entry, i) {
							entry.set('disabled', block);
					});
				}
			}
    	});
		
	
	</script>
</head>		
<body class="claro">
	<div id="login">
		<div id="loader"><div id="loaderInner"></div></div>
		<div data-dojo-type="appudo.Dialog" data-dojo-id="loginDlg" data-dojo-props="refocus:false,baseClass:'dijitTooltipContainer noClose',_onKey:function(){},style:'z-index:999;display:none;outline:none;',fBtn:true,title:nls.lin">		
			<div class="frm" style="margin:5px;">	
   				<iframe name="lfrm" id="lfrm" style="display:none"></iframe>
                                <form data-dojo-type="appudo.Form" data-dojo-id="loginFrm" data-dojo-props="region:'center',target:'lfrm',method:'post',action:'/edit/;',ctx:{nls:nls},onSubmit:function(event){loginFrm._sub(event)}">
   					<div class="e" style="display:none;margin:0 38px 0 -20px;"><label style="padding:5px;text-align:center;border:1px solid #FF1111;background:#FCE4E1;width:100%">${ctx.nls.linv}</label></div>
   					<div>
						<label style="width:5em" for="email">${ctx.nls.email}</label><input data-dojo-type="appudo.TextBox" autocomplete="on" data-dojo-props="name:'email'"><br/>
						<label style="width:5em" for="pass">${ctx.nls.pass}</label><input data-dojo-type="appudo.TextBox" autocomplete="on" data-dojo-props="type:'password',name:'pass'"><br/>		
				    	<div class="dBtn" style="text-align:center;margin:5px;">
				        	<button data-dojo-type="dijit.form.Button" type="submit" data-dojo-props="label:nls.ok"></button>
				    	</div>
			    	</div>
			    </form>
		    </div>	
		</div>   
	</div>
	<div id="container">
		<ul data-dojo-type="dijit.Menu" data-dojo-id="treeMenu" data-dojo-props="style:'display:none;', ctx:appudo.initCtx('treeMenu')">
			<li data-dojo-type="dijit.MenuItem" data-dojo-props="_setSelected: function(){},_onHover: function(){},_onFocus: function(){},disabled:true"></li>
			<li data-dojo-type="dijit.MenuSeparator"></li>
			<li data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:treeMenu.ctx.open, iconClass:'iOpen', label:nls.open"></li>
	        <li data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:treeMenu.ctx.rename, iconClass:'iRen', label:nls.rename"></li>
	        <li data-dojo-id="treeMenu.lock" data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:treeMenu.ctx.lock, iconClass:'iLock', label:nls.lock"></li>
	        <li data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:treeMenu.ctx.del, iconClass:'iDel', label:nls.del"></li>			
		</ul>	
		<ul data-dojo-type="dijit.Menu" data-dojo-id="gridMenu" data-dojo-props="style:'display:none;', ctx:appudo.initCtx('gridMenu')">
	        <li data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:gridMenu.ctx.open, iconClass:'iOpen', label:nls.open"></li>
	        <li data-dojo-id="gridMenu.into" data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:gridMenu.ctx.into, iconClass:'iInt', label:nls.goInto"></li>
	        <li data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:gridMenu.ctx.del, iconClass:'iDel', label:nls.del"></li>		
		</ul>	
		<div data-dojo-type="appudo.TTDlg" data-dojo-id="askDlg" data-dojo-props="style:'display:none;outline: none;', ctx:appudo.initCtx('askDlg'), onBlur:function(){askDlg.ctx.blur()},fBtn:true">
			<label class="dLabel" style="display:block;margin-bottom:6px"></label>
			<div data-dojo-type="dijit.form.Form"> 
				<div class="dCnt"></div>
				<div class="dBtn" style="text-align:right;margin-top:6px;width:100%">
					<button data-dojo-type="dijit.form.Button" data-dojo-props="onClick:function(e){askDlg.ctx.blur()}, label:nls.n"></button>			
					<button data-dojo-type="dijit.form.Button" data-dojo-props="type:'submit', label:nls.y"></button>	
				</div>
			</div>
		</div>         
		<div data-dojo-type="appudo.Dialog" data-dojo-id="errDlg" data-dojo-props="baseClass:'dijitTooltipContainer',style:'outline: none;', title:nls.err">
		    <div class="dijitDialogPaneContentArea" style="margin:5px;"></div>
		    <div class="dBtn" style="text-align:center;margin:5px;">
		        <button data-dojo-type="dijit.form.Button" type="button" onClick="errDlg.onCancel();" data-dojo-props="label:nls.ok"></button>
		    </div>
		</div>      
		<div data-dojo-type="appudo.Dialog" data-dojo-id="searchDlg" data-dojo-props="baseClass:'dijitTooltipContainer',style:'outline: none;', title:nls.searchr,fBtn:true, nonModal:true">
		 	<div data-dojo-type="appudo.Form" data-dojo-id="searchFrm" data-dojo-props="region:'center', ctx:{nls:nls},onSubmit:appudo.search">	
			 	<div class="frm frmx" style="margin:5px;"> 
			 		<label>${ctx.nls.search}</label><input data-dojo-type="appudo.ValidationTextBox" data-dojo-props="name:'search',invalidMessage:nls.epv"><br/>
					<label>${ctx.nls.replW}</label><input data-dojo-type="appudo.TextBox" data-dojo-props="name:'repl'"><br/>
			    </div>
			    <div class="dBtn" style="text-align:right;margin-top:6px;width:100%">
			        <button data-dojo-type="dijit.form.Button" type="submit" onclick="idx=0;" value="0" data-dojo-props="label:nls.search"></button>
			        <button data-dojo-type="dijit.form.Button" type="submit"  onclick="idx=1;" value="1" data-dojo-props="label:nls.repl"></button>
			    </div>
			    <div class="dBtn" style="text-align:right;margin-top:6px;width:100%">
					<button data-dojo-type="dijit.form.Button" type="submit" onclick="idx=2;" value="2" data-dojo-props="label:nls.replS"></button>			
					<button data-dojo-type="dijit.form.Button" type="submit" onclick="idx=3;" value="3" data-dojo-props="label:nls.replA"></button>	
				</div>
			    <div class="dBtn" style="text-align:right;margin-top:6px;">
					<button data-dojo-type="dijit.form.Button" type="button" onClick="searchDlg.onCancel();" data-dojo-props="label:nls.close"></button>	
				</div>
		    </div>
		</div>       
		<div id="main" data-dojo-type="appudo.Container" data-dojo-props="design:'sidebar'">
			<div data-dojo-type="dijit.layout.AccordionContainer" id="leftAccordion"
				 data-dojo-props="minSize:20, region:'leading', splitter:true">
				<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="baseClass:'cPane dijitContentPane', title:nls.pageTree, AutoSize:'Fill'">
					<div data-dojo-id="pageBar" data-dojo-type="dijit.Toolbar" data-dojo-props="ctx:appudo.initCtx('pageBar')">
						<div data-dojo-type="appudo.AddDropDown" data-dojo-props="iconClass:'iEye', label:nls.filterTree">
							<div data-dojo-type="dijit.Menu" data-dojo-props="title:''">
								<div data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="onChange:pageBar.ctx.pchg,checked:true,label:'<span class=\'iPage appudoIconR\'>'+nls.showPages+'</span>'"></div>	
								<div data-dojo-type="dijit.CheckedMenuItem" data-dojo-props="onChange:pageBar.ctx.mchg,checked:true,label:'<span class=\'iModRun appudoIconR\'>'+nls.showModules+'</span>'"></div>						
							</div>				
						</div>
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iLock', disableItem:pageBar, onClick:pageBar.ctx.lock, label:nls.lock"></div>					
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iDel', disableItem:pageBar, onClick:pageBar.ctx.del, label:nls.del"></div>
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iModIAdd', disableItem:pageBar, onClick:pageBar.ctx.addM, label:nls.newMInst"></div>
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iPageAdd', disableItem:pageBar, onClick:pageBar.ctx.addP, label:nls.newPage"></div>
					</div>
					<div data-dojo-type="appudo.Container" style="padding-bottom:27px;">
	   					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="overflow:visible;padding:2px;">
	   						<div data-dojo-id="pageTree" data-dojo-type="appudo.PageTree" data-dojo-props="acceptFromId:'pageTree', model:models.pageModel, blurNode:pageBar"></div>
						</div>
					</div>
	    		</div>
			</div>
	    	<div id="mainbar" data-dojo-id="mainbar" data-dojo-type="appudo.MenuBar" data-dojo-props="region:'top', ctx:appudo.initCtx('mainbar')"> 
                        <div data-dojo-type="dijit.PopupMenuBarItem" data-dojo-props="label:nls.file,disabled:true">
		        	<div data-dojo-type="dijit.Menu">
	    				<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.save, label:nls.save"></div>  	
	    				<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.saveAll, label:nls.saveAll"></div>  	
	    				<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.closeAll, label:nls.closeAll"></div>  
		        	</div>   
		        </div>  	
                        <div data-dojo-type="dijit.PopupMenuBarItem" data-dojo-props="label:nls.edit,disabled:true">
		        	<div data-dojo-type="dijit.Menu">
		            	<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.undo, label:nls.undo"></div>
		                <div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.redo, label:nls.redo"></div>
		        	</div>
		        </div>    
                        <div data-dojo-type="dijit.PopupMenuBarItem" data-dojo-props="label:nls.search,disabled:true">
		        	<div data-dojo-type="dijit.Menu">
		         		<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.search, label:nls.fileSearch"></div>
		        	</div>
		        </div>    	 
                        <div data-dojo-type="dijit.PopupMenuBarItem" data-dojo-props="label:nls.project">
                                <div data-dojo-type="dijit.Menu">
                                <div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.pack, label:nls.pkg"></div>
                                <div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.oview, label:nls.dOver,disabled:true"></div>
		            	<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.clear, label:nls.clearCache,disabled:true"></div>
		            	<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.props, label:nls.props,disabled:true"></div>
		        	</div>
		        </div>    	
		        <div data-dojo-type="dijit.PopupMenuBarItem" data-dojo-props="label:nls.help">
		        	<div data-dojo-type="dijit.Menu">
		            	<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.wcm, label:nls.welcome"></div>
		            	<div data-dojo-type="dijit.MenuItem" data-dojo-props="onClick:mainbar.ctx.about, label:nls.about"></div>
		        	</div>
		        </div>    
		        <div data-dojo-type="dijit.MenuBarItem" data-dojo-props="onClick:mainbar.ctx.logout, label:nls.logout"></div> 		  	 	
		        <div data-dojo-type="appudo.IconBarItem" data-dojo-id="ltask" data-dojo-props="iconClass:'dijitIconLoading',onClick:mainbar.ctx.load, style:'display:none;float:right;margin-top:-4px',label:nls.load"></div> 	
	    	 </div>   		
                <div id="mainTab" data-dojo-id="mainTab" data-dojo-type="appudo.MainTab" data-dojo-props="region:'center'">
	    	</div>
	    	<div data-dojo-type="dijit.layout.AccordionContainer" id="rightAccordion"
				 data-dojo-props="minSize:20, region:'trailing', splitter:true">	
					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="baseClass:'cPane dijitContentPane', AutoSize:'Fill', title:nls.files">
						<div data-dojo-id="fileBar" data-dojo-type="dijit.Toolbar" data-dojo-props="ctx:appudo.initCtx('fileBar')">
							<div class="fProg" style="display:none;float:left">
								<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iRew',onClick:fileBar.ctx.stop,label:nls.upstop"></div>
								<div data-dojo-id="upBar" data-dojo-type="dijit.ProgressBar" data-dojo-props="style:'top:2px;right:100px;left:28px;position:absolute'"></div>
							</div>
							<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iDel', disableItem:fileBar, onClick:fileBar.ctx.del, label:nls.del"></div>	
							<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iPlainAdd', disableItem:fileBar, onClick:fileBar.ctx.addF, label:nls.newFile"></div>			
							<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iFolderAdd', disableItem:fileBar, onClick:fileBar.ctx.addD, label:nls.newFolder"></div>	
							<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iFileAdd', disableItem:fileBar, onClick:fileBar.ctx.upF, label:nls.upload"></div>	
						</div>
						<div data-dojo-type="appudo.Container" style="padding-bottom:27px;">
		   					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="overflow:visible;padding:2px;">
		     					<div data-dojo-type="appudo.FileTree" data-dojo-id="fileTree" data-dojo-props="model:models.fileModel, blurNode:fileBar">
								</div>
							</div>
						</div>
					</div>	
				<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="baseClass:'cPane dijitContentPane', AutoSize:'Fill', title:nls.groups">
					<div data-dojo-id="userBar" data-dojo-type="dijit.Toolbar" data-dojo-props="ctx:appudo.initCtx('userBar')">	
	       				<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iLock', disableItem:userBar, onClick:userBar.ctx.lock, label:nls.lock"></div>
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iDel', disableItem:userBar, onClick:userBar.ctx.del, label:nls.del"></div>			
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iGroupAdd', disableItem:userBar, onClick:userBar.ctx.addG, label:nls.newGroup"></div>			
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iUserAdd', disableItem:userBar, onClick:userBar.ctx.addU, label:nls.newUser"></div>				
					</div>
					<div data-dojo-type="appudo.Container" style="padding-bottom:27px;">
	   					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="overflow:visible;padding:2px;">
	     					<div data-dojo-id="userTree" data-dojo-type="appudo.UserTree" data-dojo-props="model:models.userModel, blurNode:userBar">
							</div>
						</div>
					</div>
                                </div>
                                <!--
                                <div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="baseClass:'cPane dijitContentPane', AutoSize:'Fill', title:nls.modules">
					<div data-dojo-id="modBar" data-dojo-type="dijit.Toolbar" data-dojo-props="ctx:appudo.initCtx('modBar')">
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iDel', disableItem:modBar, onClick:modBar.ctx.del, label:nls.del"></div>			
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iFolderAdd', disableItem:modBar, onClick:modBar.ctx.addD, label:nls.newFolder"></div>			
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iModAdd', disableItem:modBar, onClick:modBar.ctx.addM, label:nls.newModule"></div>					
					</div>
					<div data-dojo-type="appudo.Container" style="padding-bottom:27px;">
	   					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="overflow:visible;padding:2px;">
                                                <div data-dojo-id="modTree" data-dojo-typeX="appudo.ModuleTree" data-dojo-props="model:models.modModel, blurNode:modBar">
							</div>
						</div>
					</div>
                                </div>
                                -->
				<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="baseClass:'cPane dijitContentPane', AutoSize:'Fill', title:nls.data">
					<div data-dojo-id="dataBar" data-dojo-type="dijit.Toolbar" data-dojo-props="ctx:appudo.initCtx('dataBar')">
						<div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iDel', disableItem:dataBar, onClick:dataBar.ctx.del, label:nls.del"></div>			
                                                <div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iTblAdd', disableItem:dataBar, onClick:dataBar.ctx.addT, label:nls.newTable"></div>
                                                <div data-dojo-type="appudo.IconButton" data-dojo-props="iconClass:'iRowAdd', disableItem:dataBar, onClick:dataBar.ctx.addC, label:nls.newCol"></div>
					</div>
					<div data-dojo-type="appudo.Container" style="padding-bottom:27px;">
	   					<div data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="overflow:visible;padding:2px;">
	     					<div data-dojo-id="dataTree" data-dojo-type="appudo.DataTree" data-dojo-props="model:models.dataModel, blurNode:dataBar">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
